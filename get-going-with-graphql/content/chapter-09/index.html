<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="../../images/favicon.ico" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mandi Wise" />
  <title>Get Going with GraphQL</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="../../css/web.min.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="masthead">
<div class="close-button-wrapper">
<button id="masthead-close" type="button"><span>Close</span></button>
</div>
<header id="title-block-header">
<h1 class="title">Get Going with GraphQL</h1>
<p class="subtitle">Learn How to Build JavaScript Applications with Apollo Server and Apollo Client</p>
<p class="author">Mandi Wise</p>
</header>
<nav class="book-nav">
<ol class="front-matter-content">
<li><a href="../preface/index.html">Preface</a></li>
</ol>
<ol class="main-matter-content">
<li><a href="../chapter-01/index.html">Up and Running with GraphQL and Apollo Server</a></li>
<li><a href="../chapter-02/index.html">More on Queries</a></li>
<li><a href="../chapter-03/index.html">Mutating Data</a></li>
<li><a href="../chapter-04/index.html">Pagination and Search Queries</a></li>
<li><a href="../chapter-05/index.html">Documentation, Custom Scalars, and Custom Directives</a></li>
<li><a href="../chapter-06/index.html">Authentication and Authorization</a></li>
<li><a href="../chapter-07/index.html">React App Set-up</a></li>
<li><a href="../chapter-08/index.html">Apollo Client with User Authentication</a></li>
<li><a href="../chapter-09/index.html">Pagination, Mutations, and the Apollo Client Cache</a></li>
<li><a href="../chapter-10/index.html">Real-time Updates with Subscriptions</a></li>
</ol>
<ol class="back-matter-content">
<li><a href="../appendix-a/index.html">Appendix A</a></li>
<li><a href="../about-the-author/index.html">About the Author</a></li>
<li><a href="../changelog/index.html">Changelog</a></li>
</ol>
<img src="../../images/8bp-logo-white.svg" class="logo" alt="8-Bit Press Inc. logo" />
</nav>
</div>
<div id="chapter">
<div class="chapter-nav">
<nav id="TOC" role="doc-toc">
<button id="masthead-open" type="button"><span>Book Navigation</span></button>
<h2 id="toc-title">Contents</h2>
<ul>
<li><a href="#pagination-mutations-and-the-apollo-client-cache">Chapter 9: Pagination, Mutations, and the Apollo Client Cache</a>
<ul>
<li><a href="#paginate-the-list-of-books-on-the-index-page">Paginate the List of Books on the Index Page</a></li>
<li><a href="#display-a-single-book-with-details">Display a Single Book with Details</a></li>
<li><a href="#add-and-remove-books-from-a-library">Add and Remove Books from a Library</a></li>
<li><a href="#add-pagination-to-the-home-page">Add Pagination to the Home Page</a></li>
<li><a href="#add-book-search">Add Book Search</a></li>
<li><a href="#create-a-book-review">Create a Book Review</a></li>
<li><a href="#update-a-book-review">Update a Book Review</a></li>
<li><a href="#delete-a-book-review">Delete a Book Review</a></li>
<li><a href="#create-a-new-book-with-authors">Create a New Book with Authors</a></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>
</div>
<div class="content">
<h1 id="pagination-mutations-and-the-apollo-client-cache">Chapter 9: Pagination, Mutations, and the Apollo Client Cache</h1>
<div class="boxout">
<p>In this chapter, we will:</p>
<ul>
<li>Customize how data is stored in Apollo Client’s normalized cache</li>
<li>Paginate lists of books on the index and home pages</li>
<li>Add a route to display a single book with its details</li>
<li>Allow users to add and remove books from their library</li>
<li>Add a book search form and a route to display results</li>
<li>Allow users to create, update, and delete their book reviews</li>
<li>Create a form that allows users to submit new books</li>
</ul>
</div>
<h2 id="paginate-the-list-of-books-on-the-index-page">Paginate the List of Books on the Index Page</h2>
<p>Bibliotech’s React application has started to take shape now, and by the end of this chapter the majority of its features will be in place. Our next step will be to load more results when a user clicks the “Load More” button on the index page. We’ll lay some essential groundwork first and then learn about how the Apollo Client 3 cache works so we can properly merge additional results into this normalized cache and trigger a re-render of the user interface.</p>
<p>As a starting point, we’ll update the <code>Index</code> page component so that it stores the <code>limit</code> argument value in a variable inside the component. We’ll also destructure the built-in <code>fetchMore</code> function from <code>useQuery</code> so that we can use it to send follow-up queries for additional pages of results when the “Load More” button is clicked:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Index/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Index</span><span class="p">()</span> <span class="p">{</span>
<span class="hll">  <span class="kr">const</span> <span class="nx">limit</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</span><span class="hll">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">fetchMore</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">GetBooks</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">page</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span>  <span class="p">});</span>

  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Index</span><span class="p">;</span>
</pre></div>

<p>Now we can update the <code>Button</code> component to call the <code>fetchMore</code> function in its <code>onClick</code> prop:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Index/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Index</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">books</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
<span class="hll">      <span class="nx">pageInfo</span><span class="o">:</span> <span class="p">{</span> <span class="nx">hasNextPage</span><span class="p">,</span> <span class="nx">page</span> <span class="p">},</span>
</span>      <span class="nx">results</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">books</span><span class="p">;</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">BookGrid</span> <span class="na">books</span><span class="o">=</span><span class="p">{</span><span class="nx">results</span><span class="p">}</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="nx">hasNextPage</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex justify-center&quot;</span><span class="p">&gt;</span>
<span class="hll">            <span class="p">&lt;</span><span class="nt">Button</span>
</span><span class="hll">              <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                <span class="nx">fetchMore</span><span class="p">({</span>
</span><span class="hll">                  <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">page</span><span class="o">:</span> <span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="hll">                <span class="p">});</span>
</span><span class="hll">              <span class="p">}}</span>
</span><span class="hll">              <span class="na">text</span><span class="o">=</span><span class="s">&quot;Load More&quot;</span>
</span><span class="hll">              <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span>
</span><span class="hll">            <span class="p">/&gt;</span>
</span>          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">)}</span>
      <span class="p">&lt;/&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book list is unavailable. Please try again.&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Index</span><span class="p">;</span>
</pre></div>

<p>Under the hood, Apollo Client will now resend the <code>GetBooks</code> query for the next page of results when the user clicks the button. However, the new books won’t be rendered on the page until we provide Apollo Client with some direction about how to merge those results into its normalized cache. We haven’t concerned ourselves much with the <code>InMemoryCache</code> we passed into Apollo Client in the last chapter, but we’ll need to take a closer look at it now.</p>
<p>With the Apollo Dev Tools installed in a browser, we can view the data currently stored in the cache via the cache inspector:</p>
<p><img src="../../images/screenshots/apollo-dev-tools-book-cache-item.png" alt="Book objects stored in Apollo Client’s cache" /><br />
</p>
<p>Here we can see the book object represented mostly as we would expect, but it also contains a <code>__typename</code> field (which was added by Apollo Client) and the array of authors appears to contain objects with foreign key-like references to the relevant authors instead of the full selection of author fields as we received as data in the query response. Scrolling through the cache, we can eventually find some author objects as well:</p>
<p><img src="../../images/screenshots/apollo-dev-tools-author-cache-item.png" alt="Author objects stored in Apollo Client’s cache" /><br />
</p>
<p>What we have seen here is the “normalized” aspect of Apollo Client’s cache in action. Apollo Client will generate a unique ID for the identifiable objects included in a query response and then store that data in a flat lookup table. By default, and as we can see above, the cache will construct a cache key from the <code>__typename</code> and the <code>id</code> or <code>_id</code> field of an object, if it’s available. Otherwise, we can specify a different unique identifier field for the object in the cache options. This is why we have so far always included the <code>id</code> field for Object types in query selection sets even when it isn’t required directly in the component.</p>
<p>Later on, if an updated version of a cached object is received in another query, then it will be merged with the existing object.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Caching response data in this manner can help us avoid sending requests to the server for later queries when the data may be retrieved locally from the in-memory cache. Now let’s take a look at what get’s cached for the query root operation type after the first page of results is rendered on the index page:</p>
<p><img src="../../images/screenshots/apollo-dev-tools-1.png" alt="Default cache key a single page of results for the books query" /><br />
</p>
<p>If we click the “Load More” button, then the cache will update with another <code>books</code> entry:</p>
<p><img src="../../images/screenshots/apollo-dev-tools-2.png" alt="Default cache keys for the first two pages of results for the books query" /><br />
</p>
<p>We can see now that the two pages of book results end up on two different fields on the <code>ROOT_QUERY</code> cache object, rather than being merged like an updated author or book object as we might expect. The reason is that the Apollo Client cache has no way of knowing how to merge fields with different combinations of arguments or complex lists of results. What Apollo Client 3 does have, however, is an API that allows us to explain to the cache how we want these results to be merged and stored as a single field using a <em>field policy</em>. To define field policies, we’ll create a new file called <code>typePolicies.js</code> in <code>client/src/graphql</code> and add the following code to it:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/typePolicies.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">typePolicies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">books</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// Field policy for the books query will go here...</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typePolicies</span><span class="p">;</span>
</pre></div>

<p>Ultimately, we want all pages of book results for this query to be contained within a single field on the <code>ROOT_QUERY</code> cache object. That means that pagination arguments won’t be relevant to how this field should be cached, so we can disable them as follows:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/typePolicies.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">typePolicies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">books</span><span class="o">:</span> <span class="p">{</span>
<span class="hll">        <span class="nx">keyArgs</span><span class="o">:</span> <span class="kc">false</span>
</span>      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typePolicies</span><span class="p">;</span>
</pre></div>

<p>We can then pass our new <code>typePolicies</code> into the <code>inMemoryCache</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/apollo.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">ApolloClient</span><span class="p">,</span> <span class="nx">HttpLink</span><span class="p">,</span> <span class="nx">InMemoryCache</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>

<span class="hll"><span class="kr">import</span> <span class="nx">typePolicies</span> <span class="nx">from</span> <span class="s2">&quot;./typePolicies&quot;</span><span class="p">;</span>
</span>
<span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApolloClient</span><span class="p">({</span>
<span class="hll">  <span class="nx">cache</span><span class="o">:</span> <span class="k">new</span> <span class="nx">InMemoryCache</span><span class="p">({</span> <span class="nx">typePolicies</span> <span class="p">}),</span>
</span>  <span class="c1">// ...</span>
<span class="p">});</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">client</span><span class="p">;</span>
</pre></div>

<p>When the application reloads, we’ll be able to see that the <code>book</code> field is now cached without the arguments and their values:</p>
<p><img src="../../images/screenshots/apollo-dev-tools-3.png" alt="Cache key for the books query after the field policy is applied" /><br />
</p>
<p>But alas, we have a new issue! When a user clicks the “Load More” button, the second page of results will now overwrite the first page of results in the user interface, but what we want is for the second page of results to be appended to the bottom of the first page. To fix this issue, we need to define a <code>merge</code> function in the field policy as well. This function will explain to Apollo Client how to merge the <code>results</code> field of the existing list of books with the incoming page of books, update the <code>pageInfo</code> to the incoming page’s values, and set the <code>__typename</code> as the cache expects:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/apollo.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">typePolicies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">books</span><span class="o">:</span> <span class="p">{</span>
<span class="hll">        <span class="nx">keyArgs</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">merge</span><span class="p">(</span><span class="nx">existing</span><span class="p">,</span> <span class="nx">incoming</span><span class="p">,</span> <span class="p">{</span> <span class="nx">args</span><span class="o">:</span> <span class="p">{</span> <span class="nx">page</span><span class="p">,</span> <span class="nx">limit</span> <span class="p">}</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">          <span class="kr">const</span> <span class="p">{</span> <span class="nx">__typeName</span><span class="p">,</span> <span class="nx">pageInfo</span><span class="p">,</span> <span class="nx">results</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">incoming</span><span class="p">;</span>
</span><span class="hll">          <span class="kr">const</span> <span class="nx">mergedResults</span> <span class="o">=</span> <span class="nx">existing</span><span class="o">?</span><span class="p">.</span><span class="nx">results</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
</span><span class="hll">            <span class="o">?</span> <span class="nx">existing</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">            <span class="o">:</span> <span class="p">[];</span>
</span><span class="hll">
</span><span class="hll">          <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">            <span class="nx">mergedResults</span><span class="p">[(</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">limit</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class="hll">          <span class="p">}</span>
</span><span class="hll">          return <span class="p">{</span> <span class="nx">results</span><span class="o">:</span> <span class="nx">mergedResults</span><span class="p">,</span> <span class="nx">pageInfo</span><span class="p">,</span> <span class="nx">__typeName</span> <span class="p">};</span>
</span><span class="hll">        <span class="p">}</span>
</span>      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typePolicies</span><span class="p">;</span>
</pre></div>

<p>With this code in place, Apollo Client will now automatically re-render the <code>BookGrid</code> component when the cache’s <code>book</code> field has new results merged into it.</p>
<h2 id="display-a-single-book-with-details">Display a Single Book with Details</h2>
<p>We’ll now shift our attention to a completely new user interface feature—a route to display detailed information about a single book. Using URL parameters with React Router, we will format that route as <code>/book/:id</code> where <code>:id</code> represents the unique ID of a book. Using this URL parameter, we’ll be able to pass the ID from the route to a query variable when we fetch the book from the GraphQL API.</p>
<p>Before writing the new query to fetch the book data, we need to do a bit of setup first. The book page will include a paginated list of related reviews sorted in descending order by date. To render the dates in a human-readable format, we’ll install Day.js in the <code>client</code> directory:</p>
<div class="highlight"><pre><span></span>npm i dayjs@1.10.4
</pre></div>

<p>The book page will also include <code>h2</code> and <code>h3</code> elements to render the book title and review section headings respectively, so we’ll add some generic styles for these elements to <code>index.css</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/index.css</p>
</div>
<div class="highlight"><pre><span></span><span class="p">@</span><span class="k">tailwind</span> <span class="nt">base</span><span class="p">;</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="err">@apply</span> <span class="err">font-bold</span> <span class="err">leading-none</span> <span class="err">text-5xl</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="nt">h2</span> <span class="p">{</span>
</span><span class="hll">  <span class="err">@apply</span> <span class="err">font-bold</span> <span class="err">leading-none</span> <span class="err">text-4xl</span> <span class="err">text-gray-700</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="nt">h3</span> <span class="p">{</span>
</span><span class="hll">  <span class="err">@apply</span> <span class="err">font-bold</span> <span class="err">leading-none</span> <span class="err">text-3xl</span> <span class="err">text-gray-700</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span><span class="hll">
</span><span class="c">/* ... */</span>
</pre></div>

<p>Next, we’ll add a new query called <code>GetBook</code> to <code>queries.js</code>. We’ll reuse our <code>basicBook</code> fragment once again, but also add the <code>summary</code> and paginated <code>reviews</code> fields to the selection set:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/queries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">basicBook</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;./fragments&quot;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">GetBook</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="hll"><span class="sb">  query GetBook($id: ID!, $reviewsLimit: Int, $reviewsPage: Int) {</span>
</span><span class="hll"><span class="sb">    book(id: $id) {</span>
</span><span class="hll"><span class="sb">      ...basicBook</span>
</span><span class="hll"><span class="sb">      summary</span>
</span><span class="hll"><span class="sb">      reviews(</span>
</span><span class="hll"><span class="sb">        limit: $reviewsLimit</span>
</span><span class="hll"><span class="sb">        orderBy: REVIEWED_ON_DESC</span>
</span><span class="hll"><span class="sb">        page: $reviewsPage</span>
</span><span class="hll"><span class="sb">      ) {</span>
</span><span class="hll"><span class="sb">        results {</span>
</span><span class="hll"><span class="sb">          id</span>
</span><span class="hll"><span class="sb">          book {</span>
</span><span class="hll"><span class="sb">            id</span>
</span><span class="hll"><span class="sb">          }</span>
</span><span class="hll"><span class="sb">          reviewedOn</span>
</span><span class="hll"><span class="sb">          rating</span>
</span><span class="hll"><span class="sb">          reviewer {</span>
</span><span class="hll"><span class="sb">            id</span>
</span><span class="hll"><span class="sb">            name</span>
</span><span class="hll"><span class="sb">          }</span>
</span><span class="hll"><span class="sb">          text</span>
</span><span class="hll"><span class="sb">        }</span>
</span><span class="hll"><span class="sb">        pageInfo {</span>
</span><span class="hll"><span class="sb">          hasNextPage</span>
</span><span class="hll"><span class="sb">          page</span>
</span><span class="hll"><span class="sb">        }</span>
</span><span class="hll"><span class="sb">      }</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">  </span><span class="si">${</span><span class="nx">basicBook</span><span class="si">}</span><span class="sb"></span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="c1">// ...</span>
</span></pre></div>

<p>As we learned in the previous section, when we fetch additional pages of results, we need to specify a field policy that instructs Apollo Client how to standardize the cache key for the field as well as how to merge those results into the cache. The logic for merging the <code>reviews</code> field results will be the same as the <code>books</code> query, so let’s take this opportunity to refactor that code into a utility function called <code>mergePageResults</code>, and then apply the return value of that function as the field policy for each of the fields instead:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/typePolicies.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kd">function</span> <span class="nx">mergePageResults</span><span class="p">(</span><span class="nx">keyArgs</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">  <span class="k">return</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">keyArgs</span><span class="p">,</span>
</span><span class="hll">    <span class="nx">merge</span><span class="p">(</span><span class="nx">existing</span><span class="p">,</span> <span class="nx">incoming</span><span class="p">,</span> <span class="p">{</span> <span class="nx">args</span><span class="o">:</span> <span class="p">{</span> <span class="nx">page</span><span class="p">,</span> <span class="nx">limit</span> <span class="p">}</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">__typeName</span><span class="p">,</span> <span class="nx">pageInfo</span><span class="p">,</span> <span class="nx">results</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">incoming</span><span class="p">;</span>
</span><span class="hll">      <span class="kr">const</span> <span class="nx">mergedResults</span> <span class="o">=</span> <span class="nx">existing</span><span class="o">?</span><span class="p">.</span><span class="nx">results</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
</span><span class="hll">        <span class="o">?</span> <span class="nx">existing</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">        <span class="o">:</span> <span class="p">[];</span>
</span><span class="hll">
</span><span class="hll">      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">mergedResults</span><span class="p">[(</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">limit</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class="hll">      <span class="p">}</span>
</span><span class="hll">      return <span class="p">{</span> <span class="nx">results</span><span class="o">:</span> <span class="nx">mergedResults</span><span class="p">,</span> <span class="nx">pageInfo</span><span class="p">,</span> <span class="nx">__typeName</span> <span class="p">};</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">};</span>
</span><span class="hll"><span class="p">}</span>
</span><span class="hll">
</span>const typePolicies = <span class="p">{</span>
  <span class="nx">Book</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
<span class="hll">      <span class="nx">reviews</span><span class="o">:</span> <span class="nx">mergePageResults</span><span class="p">()</span>
</span>    <span class="p">}</span>
<span class="hll">  <span class="p">}</span>,
</span><span class="hll">  Query: <span class="p">{</span>
</span><span class="hll">    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">books</span><span class="o">:</span> <span class="nx">mergePageResults</span><span class="p">()</span>
</span><span class="hll">    <span class="p">}</span>
</span>  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typePolicies</span><span class="p">;</span>
</pre></div>

<p>Before we create the page component that will correspond to the <code>/book/:id</code> route, let’s add a <code>ReviewList</code> component that will render the paginated list of reviews. Create a <code>ReviewList</code> component in <code>client/src/components</code> and add an <code>index.js</code> file to it with this code:</p>
<p></p>
<div class="code-context">
<p>client/src/components/ReviewList/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">dayjs</span> <span class="nx">from</span> <span class="s2">&quot;dayjs&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">ReviewsList</span><span class="p">({</span> <span class="nx">reviews</span> <span class="p">})</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">reviews</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">rating</span><span class="p">,</span> <span class="nx">reviewedOn</span><span class="p">,</span> <span class="nx">reviewer</span><span class="p">,</span> <span class="nx">text</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;pt-10&quot;</span> <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:flex sm:justify-between mb-4 sm:mb-0&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;font-bold&quot;</span><span class="p">&gt;</span>
              <span class="p">{</span><span class="nx">reviewer</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
            <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;{</span><span class="s2">&quot; &quot;</span><span class="p">}</span>
            <span class="p">{</span><span class="nx">rating</span> <span class="o">&amp;&amp;</span> <span class="sb">`rated this book </span><span class="si">${</span><span class="nx">rating</span><span class="si">}</span><span class="sb">/5`</span><span class="p">}</span>
          <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600 text-sm mb-4&quot;</span><span class="p">&gt;</span>
            Reviewed on <span class="p">{</span><span class="nx">dayjs</span><span class="p">(</span><span class="nx">reviewedOn</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;MMMM D, YYYY&quot;</span><span class="p">)}</span>
          <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">text</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">));</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewsList</span><span class="p">;</span>
</pre></div>

<p>Now we can create our new <code>Book</code> component in <code>client/src/pages</code>. Let’s set up the component in the <code>index.js</code> file without rendering the <code>ReviewList</code> first:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useParams</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useQuery</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">GetBook</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/queries&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Button&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Loader</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Loader&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MainLayout</span> <span class="nx">from</span> <span class="s2">&quot;../../components/MainLayout&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">PageNotice</span> <span class="nx">from</span> <span class="s2">&quot;../../components/PageNotice&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ReviewsList</span> <span class="nx">from</span> <span class="s2">&quot;../../components/ReviewList&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useParams</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">reviewsLimit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">fetchMore</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">GetBook</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">reviewsLimit</span><span class="p">,</span> <span class="nx">reviewsPage</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
      <span class="nx">book</span><span class="o">:</span> <span class="p">{</span> <span class="nx">authors</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">summary</span><span class="p">,</span> <span class="nx">title</span> <span class="p">}</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex flex-col sm:flex-row items-center sm:items-start sm:justify-between border-b border-gray-300 border-solid pb-8&quot;</span><span class="p">&gt;</span>
          <span class="p">{</span><span class="nx">cover</span> <span class="o">?</span> <span class="p">(</span>
            <span class="p">&lt;</span><span class="nt">img</span>
              <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-4 sm:mb-0 w-40 sm:w-1/4 sm:order-2&quot;</span>
              <span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">cover</span><span class="p">}</span>
              <span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb"> cover`</span><span class="p">}</span>
            <span class="p">/&gt;</span>
          <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-gray-200 flex flex-none justify-center items-center mb-4 sm:mb-0 py-4 w-40 sm:w-1/4 sm:order-2&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;italic px-8 py-20 md:py-24 lg:py-32 text-center text-gray-600&quot;</span><span class="p">&gt;</span>
                Cover image unavailable
              <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">)}</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:mr-8 sm:order-1 text-center sm:text-left&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;{</span><span class="nx">title</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;leading-tight my-4 text-gray-600 text-lg&quot;</span><span class="p">&gt;{</span><span class="sb">`by </span><span class="si">${</span><span class="nx">authors</span>
              <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">author</span> <span class="p">=&gt;</span> <span class="nx">author</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">{</span><span class="nx">summary</span> <span class="o">?</span> <span class="p">(</span>
              <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">summary</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
              <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-4 italic text-gray-400&quot;</span><span class="p">&gt;</span>
                Book summary unavailable.
              <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">)}</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* List of reviews will go here... */</span><span class="p">}</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book not found!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>Above, we use React Router’s <code>useParams</code> hooks to extract the <code>id</code> URL parameter from the route. We then pass it to <code>useQuery</code> as the value of the <code>$id</code> variable. Note that we again destructure the <code>fetchMore</code> function from <code>useQuery</code> so we can fetch additional pages of reviews. Now let’s add the <code>ReviewList</code> to the component, along with a “Load More” button to get more reviews:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">({</span> <span class="nx">match</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useParams</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">reviewsLimit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">fetchMore</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">GetBook</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">reviewsLimit</span><span class="p">,</span> <span class="nx">reviewsPage</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
      <span class="nx">book</span><span class="o">:</span> <span class="p">{</span> <span class="nx">authors</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">summary</span><span class="p">,</span> <span class="nx">title</span> <span class="p">}</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">h3</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-4 sm:mb-0&quot;</span><span class="p">&gt;</span>What Readers Say<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">results</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">(</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">              <span class="p">&lt;</span><span class="nt">ReviewsList</span> <span class="na">reviews</span><span class="o">=</span><span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">results</span><span class="p">}</span> <span class="p">/&gt;</span>
</span><span class="hll">              <span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">pageInfo</span><span class="p">.</span><span class="nx">hasNextPage</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
</span><span class="hll">                <span class="p">&lt;</span><span class="nt">Button</span>
</span><span class="hll">                  <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span>
</span><span class="hll">                  <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                    <span class="nx">fetchMore</span><span class="p">({</span>
</span><span class="hll">                      <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">                        <span class="nx">reviewsLimit</span><span class="p">,</span>
</span><span class="hll">                        <span class="nx">reviewsPage</span><span class="o">:</span> <span class="nx">reviews</span><span class="p">.</span><span class="nx">pageInfo</span><span class="p">.</span><span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class="hll">                      <span class="p">}</span>
</span><span class="hll">                    <span class="p">});</span>
</span><span class="hll">                  <span class="p">}}</span>
</span><span class="hll">                  <span class="na">text</span><span class="o">=</span><span class="s">&quot;Load More&quot;</span>
</span><span class="hll">                  <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span>
</span><span class="hll">                <span class="p">/&gt;</span>
</span><span class="hll">              <span class="p">)}</span>
</span><span class="hll">            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;italic mt-4&quot;</span><span class="p">&gt;</span>No reviews for this book yet!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">)}</span>
</span><span class="hll">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span>      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book not found!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>Our <code>Book</code> page component is ready to go now so let’s add it as a route:</p>
<p></p>
<div class="code-context">
<p>client/src/router/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Switch</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router&quot;</span><span class="p">;</span>

<span class="hll"><span class="kr">import</span> <span class="nx">Book</span> <span class="nx">from</span> <span class="s2">&quot;../pages/Book&quot;</span><span class="p">;</span>
</span><span class="c1">// ...</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Routes</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">Switch</span><span class="p">&gt;</span>
      <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">      <span class="p">&lt;</span><span class="nt">PublicRoute</span> <span class="na">exact</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;/book/:id&quot;</span> <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Book</span><span class="p">}</span> <span class="p">/&gt;</span>
</span>    <span class="p">&lt;/</span><span class="nt">Switch</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Routes</span><span class="p">;</span>
</pre></div>

<p>Try navigating to a page for an existing book. It should render like this one does:</p>
<p><img src="../../images/screenshots/react-app-single-book.png" alt="A page that displays detailed information about a single book" /><br />
</p>
<p>To make it easier for users to navigate to book pages without knowing what the book IDs are, let’s also update the <code>BookGrid</code> component so that it will render the appropriate book page for users whenever they click on a book item in the list:</p>
<p></p>
<div class="code-context">
<p>client/src/components/BookGrid/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
</span><span class="hll">
</span><span class="kd">function</span> <span class="nx">BookGrid</span><span class="p">({</span> <span class="nx">books</span> <span class="p">})</span> <span class="p">{</span>
<span class="hll">  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>
</span><span class="hll">
</span>  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;gap-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4&quot;</span><span class="p">&gt;</span>
      <span class="p">{</span><span class="nx">books</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">authors</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">title</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nt">li</span>
          <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white cursor-pointer flex flex-col justify-end p-4 shadow-xl&quot;</span>
          <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span>
<span class="hll">          <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">            <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">          <span class="p">}}</span>
</span>        <span class="p">&gt;</span>
          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">))}</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">BookGrid</span><span class="p">;</span>
</pre></div>

<p>With this code in place, we should be able to navigate to any book detail page after clicking on an item in the <code>BookGrid</code>.</p>
<h2 id="add-and-remove-books-from-a-library">Add and Remove Books from a Library</h2>
<p>The new book page is shaping up, but it’s still missing an important feature. When an authenticated user views the details for an individual book, they need to be able to add or remove it from their library as well. That means we finally get to add some new mutations to the React application. We’ll start by adding <code>AddBooksToLibrary</code> and <code>RemoveBooksFromLibrary</code> mutations to <code>mutations.js</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/mutations.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">AddBooksToLibrary</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  mutation AddBooksToLibrary($input: UpdateLibraryBooksInput!) {</span>
</span><span class="hll"><span class="sb">    addBooksToLibrary(input: $input) {</span>
</span><span class="hll"><span class="sb">      id</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">RemoveBooksFromLibrary</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  mutation RemoveBooksFromLibrary($input: UpdateLibraryBooksInput!) {</span>
</span><span class="hll"><span class="sb">    removeBooksFromLibrary(input: $input) {</span>
</span><span class="hll"><span class="sb">      id</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="c1">// ...</span>
</pre></div>

<p>Before we put these mutations to use, we need to pause and consider the different states in which a book page may be rendered. The <code>/book/:id</code> route is public, so the page may be rendered for an unauthenticated user and we wouldn’t want to display any kind of user interface element that would suggest they can add a book to a library. If a user is authenticated but they don’t have the book in their library, then we’ll show them a button that allows them to add the book and trigger the <code>AddBooksToLibrary</code> mutation. Alternatively, if an authenticated user has the book in their library already, then we’ll show them a button that allows them to remove the book and that sends the <code>RemoveBooksFromLibrary</code> mutation instead.</p>
<p>We can handle conditionally rendering a button for authenticated users using the existing <code>AuthContext</code>, but the matter of calculating whether the viewer has the book in their library is a bit more complicated. We could leave it up to the client to try to sort this out, but this seems like a great opportunity to shift this work to the server and add a field to the <code>Book</code> Object type in the GraphQL API so that clients can simply request this field and render the button as needed.</p>
<p>To do this, we’ll add a boolean <code>viewerHasInLibrary</code> field to the <code>Book</code> type definition:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server-express&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="sb">  &quot;&quot;&quot;</span>
<span class="sb">  A written work that can be attributed to one or more authors and can be reviewed by users.</span>
<span class="sb">  &quot;&quot;&quot;</span>
<span class="sb">  type Book {</span>
<span class="sb">    # ...</span>
<span class="hll"><span class="sb">    &quot;A boolean indicating if the viewing user has added this book to their library.&quot;</span>
</span><span class="hll"><span class="sb">    viewerHasInLibrary: Boolean</span>
</span><span class="sb">  }</span>

<span class="sb">  # ...</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>To resolve this field, we’ll have to query the REST API’s <code>/userBooks</code> endpoint to determine if a record already exists that contains the user’s ID and the book ID. Let’s add a <code>checkViewerHasInLibrary</code> method to the <code>JsonServerApi</code> data source to assist with that:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/datasources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">checkViewerHasInLibrary</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">bookId</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/userBooks?userId=</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">&amp;bookId=</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">    <span class="k">return</span> <span class="o">!!</span><span class="nx">response</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Then we’ll update our resolvers:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Book</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">reviews</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">getBookReviews</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
<span class="hll">    <span class="p">},</span>
</span><span class="hll">    <span class="nx">viewerHasInLibrary</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">{</span> <span class="nx">dataSources</span><span class="p">,</span> <span class="nx">user</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">sub</span>
</span><span class="hll">        <span class="o">?</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">checkViewerHasInLibrary</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">book</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span><span class="hll">        <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span>    <span class="p">}</span>
  <span class="p">},</span>
  <span class="c1">// ...</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>Back on the client side, we’ll add the new <code>viewerHasInLibrary</code> field to the <code>GetBook</code> query:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/queries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">GetBook</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  query GetBook($id: ID!, $reviewsLimit: Int, $reviewsPage: Int) {</span>
<span class="sb">    book(id: $id) {</span>
<span class="sb">      ...basicBook</span>
<span class="sb">      summary</span>
<span class="hll"><span class="sb">      viewerHasInLibrary</span>
</span><span class="sb">      # ...</span>
<span class="sb">    }</span>
<span class="sb">  }</span>
<span class="sb">  </span><span class="si">${</span><span class="nx">basicBook</span><span class="si">}</span><span class="sb"></span>
<span class="sb">`</span><span class="p">;</span>

<span class="c1">// ...</span>
</pre></div>

<p>Now we’ll make our first pass at updating the <code>Book</code> page component to conditionally render a button below the book summary for authenticated users only. This button will allow those users to add or remove a book depending on whether they already have the book in their library:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">GetBook</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/queries&quot;</span><span class="p">;</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useAuth</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../context/AuthContext&quot;</span><span class="p">;</span>
</span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useParams</span><span class="p">();</span>
<span class="hll">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">viewer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useAuth</span><span class="p">();</span>
</span>  <span class="kr">const</span> <span class="nx">reviewsLimit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="c1">// ...</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
<span class="hll">      <span class="nx">book</span><span class="o">:</span> <span class="p">{</span> <span class="nx">authors</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">summary</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">viewerHasInLibrary</span> <span class="p">}</span>
</span>    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex flex-col sm:flex-row items-center sm:items-start sm:justify-between border-b border-gray-300 border-solid pb-8&quot;</span><span class="p">&gt;</span>
          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:mr-8 sm:order-1 text-center sm:text-left&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;{</span><span class="nx">title</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;leading-tight my-4 text-gray-600 text-lg&quot;</span><span class="p">&gt;{</span><span class="sb">`by </span><span class="si">${</span><span class="nx">authors</span>
              <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">author</span> <span class="p">=&gt;</span> <span class="nx">author</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">            <span class="p">{</span><span class="nx">viewer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
</span><span class="hll">              <span class="p">&lt;</span><span class="nt">Button</span>
</span><span class="hll">                <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span>
</span><span class="hll">                <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                  <span class="c1">// Run the mutation to add or remove the book here...</span>
</span><span class="hll">                <span class="p">}}</span>
</span><span class="hll">                <span class="na">text</span><span class="o">=</span><span class="p">{</span>
</span><span class="hll">                  <span class="nx">viewerHasInLibrary</span> <span class="o">?</span> <span class="s2">&quot;Remove from Library&quot;</span> <span class="o">:</span> <span class="s2">&quot;Add to Library&quot;</span>
</span><span class="hll">                <span class="p">}</span>
</span><span class="hll">              <span class="p">/&gt;</span>
</span><span class="hll">            <span class="p">)}</span>
</span>          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book not found!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>As the next step, we’ll add the <code>AddBooksToLibrary</code> and <code>RemoveBooksFromLibrary</code> mutations to the <code>Book</code> page component and conditionally send each mutation on the button click:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useParams</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useMutation</span><span class="p">,</span> <span class="nx">useQuery</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>
</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span>
</span><span class="hll">  <span class="nx">AddBooksToLibrary</span><span class="p">,</span>
</span><span class="hll">  <span class="nx">RemoveBooksFromLibrary</span>
</span><span class="hll"><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/mutations&quot;</span><span class="p">;</span>
</span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">addBooksToLibrary</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">AddBooksToLibrary</span><span class="p">);</span>
</span><span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">removeBooksFromLibrary</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">RemoveBooksFromLibrary</span><span class="p">);</span>
</span>  
  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
      <span class="nx">book</span><span class="o">:</span> <span class="p">{</span> <span class="nx">authors</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">summary</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">viewerHasInLibrary</span> <span class="p">}</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex flex-col sm:flex-row items-center sm:items-start sm:justify-between border-b border-gray-300 border-solid pb-8&quot;</span><span class="p">&gt;</span>
          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:mr-8 sm:order-1 text-center sm:text-left&quot;</span><span class="p">&gt;</span>
            <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
            <span class="p">{</span><span class="nx">viewer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
              <span class="p">&lt;</span><span class="nt">Button</span>
                <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span>
                <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="hll">                  <span class="kr">const</span> <span class="nx">variables</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="hll">                    <span class="nx">input</span><span class="o">:</span> <span class="p">{</span> <span class="nx">bookIds</span><span class="o">:</span> <span class="p">[</span><span class="nx">id</span><span class="p">],</span> <span class="nx">userId</span><span class="o">:</span> <span class="nx">viewer</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span>
</span><span class="hll">                  <span class="p">};</span>
</span><span class="hll">
</span><span class="hll">                  <span class="k">if</span> <span class="p">(</span><span class="nx">viewerHasInLibrary</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">                    <span class="nx">removeBooksFromLibrary</span><span class="p">({</span> <span class="nx">variables</span> <span class="p">});</span>
</span><span class="hll">                  <span class="p">}</span> else <span class="p">{</span>
</span><span class="hll">                    <span class="nx">addBooksToLibrary</span><span class="p">({</span> <span class="nx">variables</span> <span class="p">});</span>
</span><span class="hll">                  <span class="p">}</span>
</span>                <span class="p">}}</span>
                text=<span class="p">{</span>
                  <span class="nx">viewerHasInLibrary</span> <span class="o">?</span> <span class="s2">&quot;Remove from Library&quot;</span> <span class="o">:</span> <span class="s2">&quot;Add to Library&quot;</span>
                <span class="p">}</span>
              <span class="o">/&gt;</span>
            <span class="p">)}</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book not found!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>We run the mutation now by clicking the button and we’ll be able to see that records are added and removed from the <code>db.json</code> file. However, we have just introduced a bug into the React application because the value of <code>viewerHasInLibrary</code> isn’t automatically updated after the mutation. As a result, what’s rendered on the screen becomes out of sync with reality and a user will send the same mutation if the button is clicked more than once (that is, until the page is fully reloaded and the book details are refetched).</p>
<p>To fix this bug, we’ll need to pass an <code>update</code> option into the <code>useMutation</code> hook for each of the mutations. The <code>update</code> option allows us to update the Apollo Client cache after the mutation successfully runs so the user interface will be re-rendered based on the correct state. Because both mutations will need to update the cache in the same way, we’ll create a reusable <code>updateViewerHasInLibrary</code> function that takes the cache and the ID of the book as parameters. This function will use the <code>cache</code> object’s <code>readQuery</code> and <code>writeQuery</code> methods to get the appropriate book object from the cache and then update its <code>viewerHasInLibrary</code> field. To create this function, we’ll make a new directory called <code>utils</code> in <code>client/src</code> and add a file called <code>updateQueries.js</code> to it with the following code:</p>
<p></p>
<div class="code-context">
<p>client/src/utils/updateQueries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">GetBook</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../graphql/queries&quot;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">updateViewerHasInLibrary</span><span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">book</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">readQuery</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">GetBook</span><span class="p">,</span>
    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">cache</span><span class="p">.</span><span class="nx">writeQuery</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="nx">GetBook</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">book</span><span class="o">:</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">book</span><span class="p">,</span>
        <span class="nx">viewerHasInLibrary</span><span class="o">:</span> <span class="o">!</span><span class="nx">book</span><span class="p">.</span><span class="nx">viewerHasInLibrary</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>

<p>We can then import the function into the <code>Book</code> page component and call it inside the <code>update</code> method option for each mutation:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">updateViewerHasInLibrary</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../utils/updateQueries&quot;</span><span class="p">;</span>
</span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">addBooksToLibrary</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">AddBooksToLibrary</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">update</span><span class="o">:</span> <span class="nx">cache</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">updateViewerHasInLibrary</span><span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">});</span>
</span><span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">removeBooksFromLibrary</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">RemoveBooksFromLibrary</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">update</span><span class="o">:</span> <span class="nx">cache</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">updateViewerHasInLibrary</span><span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">});</span>
</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>Now the text on the library-updating button will toggle back and forth after a mutation completes, and the correct mutation will subsequently be sent if the button is clicked more than once.</p>
<h2 id="add-pagination-to-the-home-page">Add Pagination to the Home Page</h2>
<p>Now that users have the power to add and remove books from their libraries, these lists of books may grow quite long on the homepage, so let’s quickly add pagination for the <code>books</code> query on the <code>/home</code> route as well. To do this, we’ll update the <code>Home</code> page component much as we did when we added pagination to the index page:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Home/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Home</span><span class="p">()</span> <span class="p">{</span>
<span class="hll">  <span class="kr">const</span> <span class="nx">limit</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</span><span class="hll">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">fetchMore</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">GetViewerLibrary</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">page</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span>  <span class="p">});</span>

  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">viewer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">viewer</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">viewer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
      <span class="nx">pageInfo</span><span class="o">:</span> <span class="p">{</span> <span class="nx">hasNextPage</span><span class="p">,</span> <span class="nx">page</span> <span class="p">},</span>
      <span class="nx">results</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">viewer</span><span class="p">.</span><span class="nx">library</span><span class="p">;</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">{</span><span class="nx">hasNextPage</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex justify-center&quot;</span><span class="p">&gt;</span>
<span class="hll">            <span class="p">&lt;</span><span class="nt">Button</span>
</span><span class="hll">              <span class="na">text</span><span class="o">=</span><span class="s">&quot;Load More&quot;</span>
</span><span class="hll">              <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                <span class="nx">fetchMore</span><span class="p">({</span>
</span><span class="hll">                  <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">page</span><span class="o">:</span> <span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="hll">                <span class="p">});</span>
</span><span class="hll">              <span class="p">}}</span>
</span><span class="hll">              <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span>
</span><span class="hll">            <span class="p">/&gt;</span>
</span>          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">)}</span>
      <span class="p">&lt;/&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">viewer</span> <span class="o">||</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book list is unavailable. Please try again.&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Home</span><span class="p">;</span>
</pre></div>

<p>And to update the Apollo Client cache after fetching additional library books, we’ll add another field policy to <code>typePolicies.js</code>. However, we’ll need to take a different approach with this policy than we did with the previous two. Rather than applying it directly to the <code>viewer</code> field, we’ll add it to the <code>library</code> field on the applicable <code>User</code> in the cache because the <code>viewer</code> field on the <code>ROOT_QUERY</code> object will only contain a reference to the normalized <code>User</code> object:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/typePolicies.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">const</span> <span class="nx">typePolicies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Book</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">reviews</span><span class="o">:</span> <span class="nx">mergePageResults</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>,
<span class="hll">  User: <span class="p">{</span>
</span><span class="hll">    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">library</span><span class="o">:</span> <span class="nx">mergePageResults</span><span class="p">()</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">}</span>,
</span>  Query: <span class="p">{</span>
    <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">books</span><span class="o">:</span> <span class="nx">mergePageResults</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typePolicies</span><span class="p">;</span>
</pre></div>

<p>If the currently authenticated user has fewer than 12 books in their library, try adjusting the <code>limit</code> constant in the <code>Home</code> page component temporarily to confirm that the pagination works.</p>
<h2 id="add-book-search">Add Book Search</h2>
<p>Before we turn our attention back to mutations for the remainder of the chapter, we have one more query-related feature to add. Users likely won’t want to sift through pages and pages of alphabetically ordered results to find a specific book, so we still need to add a search form and search results page to make books in the Bibliotech catalog more discoverable.</p>
<p>To begin, we’ll add a new <code>SearchBooks</code> query to <code>queries.js</code> that will fetch books with titles that match a submitted search string, as well as the books authored by people whose names match that same string:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/queries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="hll">
</span><span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">SearchBooks</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  query SearchBooks($query: String!) {</span>
</span><span class="hll"><span class="sb">    searchBooks(query: $query, orderBy: RESULT_ASC) {</span>
</span><span class="hll"><span class="sb">      ... on Book {</span>
</span><span class="hll"><span class="sb">        ...basicBook</span>
</span><span class="hll"><span class="sb">      }</span>
</span><span class="hll"><span class="sb">      ... on Author {</span>
</span><span class="hll"><span class="sb">        books {</span>
</span><span class="hll"><span class="sb">          ...basicBook</span>
</span><span class="hll"><span class="sb">        }</span>
</span><span class="hll"><span class="sb">      }</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">  </span><span class="si">${</span><span class="nx">basicBook</span><span class="si">}</span><span class="sb"></span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span></pre></div>

<p>As we did in Chapter 4, we use inline fragments to include both books and authors with their list of books in the response. To build out the user interface elements that will support search, we’ll need both a search form to add to the index page and another page component to display search results. We’ll also include the same search form at the top of the search results page in case the user wants to do another search.</p>
<p>When the search form is submitted, the string in the search input will be used as a query parameter on the new <code>/search</code> route, and the value of that query parameter will be used as the <code>query</code> variable value in the request to the GraphQL API. React Router doesn’t have any built-in way to parse query strings, so we’ll install another package on <code>client</code> to help with this:</p>
<div class="highlight"><pre><span></span>npm i query-string@7.0.0
</pre></div>

<p>Now we’ll add a new <code>SearchBooksForm</code> component that contains a form with a single text-based input and a button. When the form is submitted, the value of the input will be used as the <code>q</code> query parameter. And when this form is rendered at the top of the search results page we’ll parse the same query parameter to pre-populate the same text in the input for the user’s convenience:</p>
<p></p>
<div class="code-context">
<p>client/src/components/SearchBooksForm/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span><span class="p">,</span> <span class="nx">useLocation</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useState</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">queryString</span> <span class="nx">from</span> <span class="s2">&quot;query-string&quot;</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../Button&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">TextInput</span> <span class="nx">from</span> <span class="s2">&quot;../TextInput&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">SearchBooksForm</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">useLocation</span><span class="p">();</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">q</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">queryString</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">query</span><span class="p">,</span> <span class="nx">setQuery</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">q</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex justify-center mb-4 w-full&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span>
        <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex flex-col sm:flex-row items-center justify-center max-w-xl w-full&quot;</span>
        <span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
          <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
          <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/search?q=</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
        <span class="p">}}</span>
      <span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">TextInput</span>
          <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex-auto sm:max-w-xs mb-4 sm:mb-0 sm:mr-2 w-10/12&quot;</span>
          <span class="na">hiddenLabel</span>
          <span class="na">id</span><span class="o">=</span><span class="s">&quot;query&quot;</span>
          <span class="na">inputWidthClass</span><span class="o">=</span><span class="s">&quot;w-full&quot;</span>
          <span class="na">label</span><span class="o">=</span><span class="s">&quot;Search for a book title or author&quot;</span>
          <span class="na">name</span><span class="o">=</span><span class="s">&quot;query&quot;</span>
          <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">setQuery</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
          <span class="p">}}</span>
          <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Search for a book title or author&quot;</span>
          <span class="na">type</span><span class="o">=</span><span class="s">&quot;search&quot;</span>
          <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">query</span><span class="p">}</span>
        <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">Button</span> <span class="na">primary</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Search&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">SearchBooksForm</span><span class="p">;</span>
</pre></div>

<p>Now we can set up the search results page. Create a <code>Search</code> directory in <code>client/src/pages</code> and add an <code>index.js</code> file to it with the following code:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Search/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useLocation</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useQuery</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">queryString</span> <span class="nx">from</span> <span class="s2">&quot;query-string&quot;</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">SearchBooks</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/queries&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">BookGrid</span> <span class="nx">from</span> <span class="s2">&quot;../../components/BookGrid&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Loader</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Loader&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MainLayout</span> <span class="nx">from</span> <span class="s2">&quot;../../components/MainLayout&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">PageNotice</span> <span class="nx">from</span> <span class="s2">&quot;../../components/PageNotice&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">SearchBooksForm</span> <span class="nx">from</span> <span class="s2">&quot;../../components/SearchBooksForm&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">Search</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">location</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useLocation</span><span class="p">();</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">q</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">queryString</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">SearchBooks</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">query</span><span class="o">:</span> <span class="nx">q</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Render search results here...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Search</span><span class="p">;</span>
</pre></div>

<p>When this component loads, we parse the <code>q</code> query parameter at the end of the route’s URL and use its value to send the <code>SearchBooks</code> query to the GraphQL API. When matching results are found, the books with matching titles will be directly available in the <code>data.searchBooks</code> array, but the books returned for authors with matching names will be nested under a <code>books</code> key in the author result, so we need to make a quick pass over the array to flatten all of the book results:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Search/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Search</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

<span class="hll">  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
</span><span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">searchBooks</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">parsedBooks</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">searchBooks</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">curr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">if</span> <span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">__typename</span> <span class="o">===</span> <span class="s2">&quot;Author&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nx">acc</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">books</span><span class="p">);</span>
</span><span class="hll">      <span class="p">}</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">acc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">curr</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span> <span class="p">[]);</span>
</span><span class="hll">
</span><span class="hll">    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="hll">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">SearchBooksForm</span> <span class="p">/&gt;</span>
</span><span class="hll">        <span class="p">{</span><span class="nx">parsedBooks</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">(</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">BookGrid</span> <span class="na">books</span><span class="o">=</span><span class="p">{</span><span class="nx">parsedBooks</span><span class="p">}</span> <span class="p">/&gt;</span>
</span><span class="hll">        <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 text-center&quot;</span><span class="p">&gt;</span>
</span><span class="hll">            No books found! Please search again.
</span><span class="hll">          <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">)}</span>
</span><span class="hll">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="hll">      <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book search is unavailable. Please try again.&quot;</span> <span class="p">/&gt;</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
</span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Search</span><span class="p">;</span>
</pre></div>

<p>The <code>Search</code> page component is ready to go, so let’s set it up as a publicly available route:</p>
<p></p>
<div class="code-context">
<p>client/src/router/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="hll"><span class="kr">import</span> <span class="nx">Search</span> <span class="nx">from</span> <span class="s2">&quot;../pages/Search&quot;</span><span class="p">;</span>
</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Routes</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">Switch</span><span class="p">&gt;</span>
      <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">      <span class="p">&lt;</span><span class="nt">PublicRoute</span> <span class="na">exact</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;/search&quot;</span> <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Search</span><span class="p">}</span> <span class="p">/&gt;</span>
</span>    <span class="p">&lt;/</span><span class="nt">Switch</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Routes</span><span class="p">;</span>
</pre></div>

<p>Lastly, we can add the <code>SearchBooksForm</code> to the index page:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Index/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="hll"><span class="kr">import</span> <span class="nx">SearchBooksForm</span> <span class="nx">from</span> <span class="s2">&quot;../../components/SearchBooksForm&quot;</span><span class="p">;</span>
</span>
<span class="kd">function</span> <span class="nx">Index</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">books</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
<span class="hll">          <span class="p">&lt;</span><span class="nt">SearchBooksForm</span> <span class="p">/&gt;</span>
</span>          <span class="p">&lt;</span><span class="nt">BookGrid</span> <span class="na">books</span><span class="o">=</span><span class="p">{</span><span class="nx">results</span><span class="p">}</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
      <span class="p">&lt;/&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book list is unavailable. Please try again.&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Index</span><span class="p">;</span>
</pre></div>

<p>Try running a few searches for various book title words and author names. The new search results page should render as follows:</p>
<p><img src="../../images/screenshots/react-app-search-results.png" alt="Lists of books rendered as search results" /><br />
</p>
<h2 id="create-a-book-review">Create a Book Review</h2>
<p>Shifting our focus back to mutations, for our next step we will add a form that submits a mutation to create a new review. To facilitate caching data for new reviews, the fields that we return from the <code>createReview</code> mutation will be the same as the fields for the review <code>results</code> field in the <code>book</code> query, so let’s make a reusable fragment to use for both of them now:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/fragments.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">fullReview</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  fragment fullReview on Review {</span>
</span><span class="hll"><span class="sb">    id</span>
</span><span class="hll"><span class="sb">    book {</span>
</span><span class="hll"><span class="sb">      id</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">    reviewedOn</span>
</span><span class="hll"><span class="sb">    rating</span>
</span><span class="hll"><span class="sb">    reviewer {</span>
</span><span class="hll"><span class="sb">      id</span>
</span><span class="hll"><span class="sb">      name</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">    text</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="c1">// ...</span>
</span></pre></div>

<p>Now we can set up a new <code>CreateReview</code> mutation using the <code>fullReview</code> fragment:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/mutations.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">fullReview</span><span class="p">,</span> <span class="nx">viewerAndToken</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;./fragments&quot;</span><span class="p">;</span>
</span>
<span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">CreateReview</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  mutation CreateReview($input: CreateReviewInput!) {</span>
</span><span class="hll"><span class="sb">    createReview(input: $input) {</span>
</span><span class="hll"><span class="sb">      ...fullReview</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">  </span><span class="si">${</span><span class="nx">fullReview</span><span class="si">}</span><span class="sb"></span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="c1">// ...</span>
</pre></div>

<p>And we can tidy up the <code>GetBook</code> query by importing the same fragment into <code>queries.js</code> and using it there as well:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/queries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>

<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">basicBook</span><span class="p">,</span> <span class="nx">fullReview</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;./fragments&quot;</span><span class="p">;</span>
</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">GetBook</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  query GetBook($id: ID!, $reviewsLimit: Int, $reviewsPage: Int) {</span>
<span class="sb">    book(id: $id) {</span>
<span class="sb">      ...basicBook</span>
<span class="sb">      summary</span>
<span class="sb">      viewerHasInLibrary</span>
<span class="sb">      viewerHasReviewed</span>
<span class="sb">      reviews(</span>
<span class="sb">        limit: $reviewsLimit</span>
<span class="sb">        orderBy: REVIEWED_ON_DESC</span>
<span class="sb">        page: $reviewsPage</span>
<span class="sb">      ) {</span>
<span class="sb">        results {</span>
<span class="hll"><span class="sb">          ...fullReview</span>
</span><span class="sb">        }</span>
<span class="sb">        pageInfo {</span>
<span class="sb">          hasNextPage</span>
<span class="sb">          page</span>
<span class="sb">        }</span>
<span class="sb">      }</span>
<span class="sb">    }</span>
<span class="sb">  }</span>
<span class="hll"><span class="sb">  </span><span class="si">${</span><span class="nx">basicBook</span><span class="si">}</span><span class="sb"></span>
</span><span class="sb">  </span><span class="si">${</span><span class="nx">fullReview</span><span class="si">}</span><span class="sb"></span>
<span class="sb">`</span><span class="p">;</span>

<span class="c1">// ...</span>
</pre></div>

<p>Users will be able to access the form for book review submissions from the book page. And just as we conditionally rendered some of the book page’s components based on whether the user was authenticated and if they already had the book in their library, we will also conditionally render the button that will direct an authenticated user to the book review form, but only if they haven’t reviewed the book yet. To assist with this conditional rendering, we’ll add a boolean <code>viewerHasReviewed</code> field to the <code>Book</code> type definition:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server-express&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="sb">  &quot;&quot;&quot;</span>
<span class="sb">  A written work that can be attributed to one or more authors and can be reviewed by users.</span>
<span class="sb">  &quot;&quot;&quot;</span>
<span class="sb">  type Book {</span>
<span class="sb">    # ...</span>
<span class="hll"><span class="sb">    &quot;A boolean indicating if the viewing user has reviewed the book.&quot;</span>
</span><span class="hll"><span class="sb">    viewerHasReviewed: Boolean</span>
</span><span class="sb">  }</span>

<span class="sb">  # ...</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>Then we’ll add a <code>checkViewerHasReviewed</code> method to the <code>JsonServerApi</code> data source, similar to the <code>checkViewerHasInLibrary</code> method that we previously added:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/datasources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">checkViewerHasReviewed</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">bookId</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/reviews?bookId=</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">&amp;userId=</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">    <span class="k">return</span> <span class="o">!!</span><span class="nx">response</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Now we’ll add the resolver for the new <code>viewerHasReviewed</code> field:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Book</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">viewerHasInLibrary</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">{</span> <span class="nx">dataSources</span><span class="p">,</span> <span class="nx">user</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...</span>
<span class="hll">    <span class="p">},</span>
</span><span class="hll">    <span class="nx">viewerHasReviewed</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">{</span> <span class="nx">dataSources</span><span class="p">,</span> <span class="nx">user</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">sub</span>
</span><span class="hll">        <span class="o">?</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">checkViewerHasReviewed</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">book</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span><span class="hll">        <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span>    <span class="p">}</span>
  <span class="p">},</span>
  <span class="c1">// ...</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>And one more time, we’ll update the <code>GetBook</code> query so that it includes the new field in its selection set now:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/queries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">GetBook</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  query GetBook($id: ID!, $reviewsLimit: Int, $reviewsPage: Int) {</span>
<span class="sb">    book(id: $id) {</span>
<span class="sb">      ...basicBook</span>
<span class="sb">      summary</span>
<span class="sb">      viewerHasInLibrary</span>
<span class="hll"><span class="sb">      viewerHasReviewed</span>
</span><span class="sb">      # ...</span>
<span class="sb">    }</span>
<span class="sb">  }</span>
<span class="sb">  </span><span class="si">${</span><span class="nx">basicBook</span><span class="si">}</span><span class="sb"></span>
<span class="sb">`</span><span class="p">;</span>
</pre></div>

<p>Moving on, the book review form that we will build contains two fields—a text input for the review’s optional text-based content and a select menu for choosing the required numerical book rating. We can reuse the existing <code>TextInput</code> component for the text content, but we’ll need to add a new <code>Select</code> component for the rating field. Create a <code>Select</code> directory in <code>client/src/components</code> and add an <code>index.js</code> file to it with the following code:</p>
<p></p>
<div class="code-context">
<p>client/src/components/Select/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Select</span><span class="p">({</span>
  <span class="nx">className</span><span class="p">,</span>
  <span class="nx">hiddenLabel</span><span class="p">,</span>
  <span class="nx">id</span><span class="p">,</span>
  <span class="nx">label</span><span class="p">,</span>
  <span class="nx">name</span><span class="p">,</span>
  <span class="nx">onChange</span><span class="p">,</span>
  <span class="nx">options</span><span class="p">,</span>
  <span class="nx">selectWidthClass</span><span class="p">,</span>
  <span class="nx">value</span><span class="p">,</span>
  <span class="p">...</span><span class="nx">rest</span>
<span class="p">})</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">className</span><span class="p">}&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span>
        <span class="na">htmlFor</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span>
        <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="sb">`block font-semibold </span><span class="si">${</span><span class="nx">hiddenLabel</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;sr-only&quot;</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span>
      <span class="p">&gt;</span>
        <span class="p">{</span><span class="nx">label</span><span class="p">}</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="sb">`inline-block relative w-64 </span><span class="si">${</span><span class="nx">selectWidthClass</span><span class="si">}</span><span class="sb">`</span><span class="p">}&gt;</span>
        <span class="p">&lt;</span><span class="nt">select</span>
          <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="sb">`block appearance-none w-full bg-white focus:bg-gray-100 border-b-2 border-red-500 hover:border-red-700 px-4 py-2 pr-8 leading-tight focus:outline-none w-full`</span><span class="p">}</span>
          <span class="na">id</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span>
          <span class="na">name</span><span class="o">=</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
          <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">onChange</span><span class="p">}</span>
          <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span>
          <span class="p">{</span><span class="na">...rest</span><span class="p">}</span>
        <span class="p">&gt;</span>
          <span class="p">{</span><span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">value</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">(</span>
            <span class="p">&lt;</span><span class="nt">option</span> <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">value</span><span class="p">}&gt;</span>
              <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
            <span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
          <span class="p">))}</span>
        <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">svg</span>
            <span class="na">className</span><span class="o">=</span><span class="s">&quot;fill-current h-4 w-4&quot;</span>
            <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/2000/svg&quot;</span>
            <span class="na">viewBox</span><span class="o">=</span><span class="s">&quot;0 0 20 20&quot;</span>
          <span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">path</span> <span class="na">d</span><span class="o">=</span><span class="s">&quot;M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z&quot;</span> <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">svg</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Select</span><span class="p">;</span>
</pre></div>

<p>Now we’re ready to set up a new <code>ReviewBook</code> page component containing the book review form. The page that contains this form will be available at the <code>/book/:bookId/review/new</code> route, so we can get the <code>bookId</code> URL parameter using React Router’s <code>useParams</code> hook and then use it as the <code>$bookId</code> variable value in the mutation later on. We’ll also need its <code>useHistory</code> hook so we can push the viewer back to the book page after they’ve submitted the form so they can see their new review. And because we’re building another form with controlled components, we’ll need to manage some state for each of the form fields:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/ReviewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span><span class="p">,</span> <span class="nx">useParams</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useMutation</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useState</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">CreateReview</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/mutations&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useAuth</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../context/AuthContext&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Button&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MainLayout</span> <span class="nx">from</span> <span class="s2">&quot;../../components/MainLayout&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">PageNotice</span> <span class="nx">from</span> <span class="s2">&quot;../../components/PageNotice&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Select</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Select&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">TextInput</span> <span class="nx">from</span> <span class="s2">&quot;../../components/TextInput&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">ReviewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">bookId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useParams</span><span class="p">();</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">viewer</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">viewerError</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useAuth</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>

  <span class="kr">const</span> <span class="p">[</span><span class="nx">rating</span><span class="p">,</span> <span class="nx">setRating</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">text</span><span class="p">,</span> <span class="nx">setText</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

  <span class="kr">const</span> <span class="p">[</span><span class="nx">createReview</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">CreateReview</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">onCompleted</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kr">const</span> <span class="nx">handleSubmit</span> <span class="o">=</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="nx">createReview</span><span class="p">({</span>
      <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">input</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">bookId</span><span class="p">,</span>
          <span class="nx">rating</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">rating</span><span class="p">),</span>
          <span class="nx">reviewerId</span><span class="o">:</span> <span class="nx">viewer</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
          <span class="nx">text</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewBook</span><span class="p">;</span>
</pre></div>

<p>The review form itself will contain the following code:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/ReviewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">ReviewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

<span class="hll">  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="nx">viewer</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="hll">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>Create a New Review<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}&gt;</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">Select</span>
</span><span class="hll">            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6&quot;</span>
</span><span class="hll">            <span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span>
</span><span class="hll">            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Rating&quot;</span>
</span><span class="hll">            <span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span>
</span><span class="hll">            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">              <span class="nx">setRating</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span><span class="hll">            <span class="p">}}</span>
</span><span class="hll">            <span class="na">options</span><span class="o">=</span><span class="p">{[</span>
</span><span class="hll">              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span> <span class="p">}</span>,
</span><span class="hll">              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span> <span class="p">}</span>,
</span><span class="hll">              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;3&quot;</span> <span class="p">}</span>,
</span><span class="hll">              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;4&quot;</span> <span class="p">}</span>,
</span><span class="hll">              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;5&quot;</span> <span class="p">}</span>
</span><span class="hll">            <span class="p">]}</span>
</span><span class="hll">            value=<span class="p">{</span><span class="nx">rating</span><span class="p">}</span>
</span><span class="hll">          <span class="o">/&gt;</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">TextInput</span>
</span><span class="hll">            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6 w-full&quot;</span>
</span><span class="hll">            <span class="na">id</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
</span><span class="hll">            <span class="na">inputWidthClass</span><span class="o">=</span><span class="s">&quot;w-full&quot;</span>
</span><span class="hll">            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Your Review&quot;</span>
</span><span class="hll">            <span class="na">name</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
</span><span class="hll">            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">              <span class="nx">setText</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span><span class="hll">            <span class="p">}}</span>
</span><span class="hll">            <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Write a brief review of the book&quot;</span>
</span><span class="hll">            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class="hll">          <span class="p">/&gt;</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">Button</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span> <span class="na">primary</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="p">/&gt;</span>
</span><span class="hll">        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span><span class="hll">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">viewerError</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Something went wrong. Please try again!&quot;</span> <span class="p">/&gt;;</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
</span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewBook</span><span class="p">;</span>
</pre></div>

<p>Next, we’ll we wire up a new route for the <code>ReviewBook</code> page component:</p>
<p></p>
<div class="code-context">
<p>client/src/router/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="hll"><span class="kr">import</span> <span class="nx">ReviewBook</span> <span class="nx">from</span> <span class="s2">&quot;../pages/ReviewBook&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="nx">Search</span> <span class="nx">from</span> <span class="s2">&quot;../pages/Search&quot;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Routes</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">Switch</span><span class="p">&gt;</span>
      <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">      <span class="p">&lt;</span><span class="nt">PrivateRoute</span>
</span><span class="hll">        <span class="na">exact</span>
</span><span class="hll">        <span class="na">path</span><span class="o">=</span><span class="s">&quot;/book/:bookId/review/new&quot;</span>
</span><span class="hll">        <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">ReviewBook</span><span class="p">}</span>
</span><span class="hll">      <span class="p">/&gt;</span>
</span>      <span class="p">&lt;</span><span class="nt">PublicRoute</span> <span class="na">exact</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;/search&quot;</span> <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Search</span><span class="p">}</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">Switch</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Routes</span><span class="p">;</span>
</pre></div>

<p>Circling back on the new <code>viewerHasReviewed</code> field, we’ll update the <code>Book</code> page component so that it destructures the new field after loading the book data and then uses the value to determine if an “Add a Review” button should be displayed next to the review section heading:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span><span class="p">,</span> <span class="nx">useParams</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useMutation</span><span class="p">,</span> <span class="nx">useQuery</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useParams</span><span class="p">();</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">viewer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useAuth</span><span class="p">();</span>
<span class="hll">  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>
</span>  <span class="kr">const</span> <span class="nx">reviewsLimit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="c1">// ...</span>

  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span>
<span class="hll">      <span class="nx">book</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">authors</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">cover</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">reviews</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">summary</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">title</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">viewerHasInLibrary</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">viewerHasReviewed</span>
</span><span class="hll">      <span class="p">}</span>
</span>    <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    
    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
<span class="hll">          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:flex sm:justify-between&quot;</span><span class="p">&gt;</span>
</span>            <span class="p">&lt;</span><span class="nt">h3</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-4 sm:mb-0&quot;</span><span class="p">&gt;</span>What Readers Say<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="hll">            <span class="p">{</span><span class="nx">viewer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">viewerHasReviewed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
</span><span class="hll">              <span class="p">&lt;</span><span class="nt">Button</span>
</span><span class="hll">                <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                  <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">/review/new`</span><span class="p">);</span>
</span><span class="hll">                <span class="p">}}</span>
</span><span class="hll">                <span class="na">primary</span>
</span><span class="hll">                <span class="na">text</span><span class="o">=</span><span class="s">&quot;Add a Review&quot;</span>
</span><span class="hll">              <span class="p">/&gt;</span>
</span><span class="hll">            <span class="p">)}</span>
</span><span class="hll">          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span>          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book not found!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>Try navigating to a book that the authenticated user hasn’t reviewed yet and click the “Add a Review” button. The book review form will render as pictured:</p>
<p><img src="../../images/screenshots/react-app-create-review-form.png" alt="A form that allows users to create new book reviews" /><br />
</p>
<p>The book review form is fully operational, but if we try submitting a review through it now, then we’ll encounter what appears to be a bug in the book page’s user interface. Specifically, the new review won’t appear in the list until we do a full page refresh. So to fix this bug, we’ll need to make one more update to the <code>Book</code> page component by setting the <code>fetchPolicy</code> option to <code>cache-and-network</code> for the <code>GetBook</code> query, as well as a <code>nextFetchPolicy</code> of <code>cache-first</code> when fetching subsequent pages of review results. By choosing these fetch policies, the book page will no longer load with stale data from the cache after the review is submitted:</p>
<p>client/src/pages/Book/index.js</p>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">fetchMore</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">GetBook</span><span class="p">,</span> <span class="p">{</span>
<span class="hll">    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">reviewsLimit</span><span class="p">,</span> <span class="nx">reviewsPage</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class="hll">    <span class="nx">fetchPolicy</span><span class="o">:</span> <span class="s2">&quot;cache-and-network&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="nx">nextFetchPolicy</span><span class="o">:</span> <span class="s2">&quot;cache-first&quot;</span>
</span>  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>  
</pre></div>

<div class="boxout">
<p>By default, Apollo Client uses a <code>cache-first</code> fetch policy for all queries to help minimize network requests, but in some instances, we need to override this policy to ensure that the data displayed on the screen and stored in the cache is in sync with the data on the server. You can read more about different fetch policies in the <a href="https://www.apollographql.com/docs/react/data/queries/#supported-fetch-policies">Apollo Client documentation</a>.</p>
</div>
<p>With this code in place, the book review form should be fully operational for authenticated users. Try adding at least one new review before moving on to the next section, as it will build on top of this form to support updates to existing reviews too.</p>
<h2 id="update-a-book-review">Update a Book Review</h2>
<p>Now that the book review form can add reviews, we can reuse the same <code>ReviewBook</code> page component to allow users to update their existing reviews as well. Let’s begin by adding an <code>UpdateReview</code> mutation to <code>mutations.js</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/mutations.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
<span class="hll">
</span><span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">UpdateReview</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  mutation UpdateReview($input: UpdateReviewInput!) {</span>
</span><span class="hll"><span class="sb">    updateReview(input: $input) {</span>
</span><span class="hll"><span class="sb">      ...fullReview</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">  </span><span class="si">${</span><span class="nx">fullReview</span><span class="si">}</span><span class="sb"></span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span></pre></div>

<p>Next, we’ll declare a new route to render the <code>ReviewBook</code> page component when it’s used to update a book. The <code>path</code> will be very similar to the other route we added for creating new reviews, except this time it will use a <code>:reviewId</code> URL parameter at the end of the route instead of <code>new</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/router/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Routes</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">Switch</span><span class="p">&gt;</span>
      <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">      <span class="p">&lt;</span><span class="nt">PrivateRoute</span>
</span><span class="hll">        <span class="na">exact</span>
</span><span class="hll">        <span class="na">path</span><span class="o">=</span><span class="s">&quot;/book/:bookId/review/:reviewId&quot;</span>
</span><span class="hll">        <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">ReviewBook</span><span class="p">}</span>
</span><span class="hll">      <span class="p">/&gt;</span>
</span>      <span class="p">&lt;</span><span class="nt">PublicRoute</span> <span class="na">exact</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;/search&quot;</span> <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Search</span><span class="p">}</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">Switch</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Routes</span><span class="p">;</span>
</pre></div>

<p>To help users access the form to update their existing reviews, we’ll conditionally render an “Update” button in the <code>ReviewList</code> component next to any review that they wrote. To do that, we must add a <code>viewerId</code> prop to the component so we can compare it to the <code>id</code> of the user that wrote each review in the list, and we also need to add a <code>bookId</code> prop so we can push the user to the correct route to update the review:</p>
<p></p>
<div class="code-context">
<p>client/src/components/ReviewList/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="nx">dayjs</span> <span class="nx">from</span> <span class="s2">&quot;dayjs&quot;</span><span class="p">;</span>

<span class="hll"><span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Button&quot;</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="kd">function</span> <span class="nx">ReviewsList</span><span class="p">({</span> <span class="nx">bookId</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">viewerId</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">return</span> <span class="nx">reviews</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">rating</span><span class="p">,</span> <span class="nx">reviewedOn</span><span class="p">,</span> <span class="nx">reviewer</span><span class="p">,</span> <span class="nx">text</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">(</span>
</span>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;pt-10&quot;</span> <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:flex sm:justify-between mb-4 sm:mb-0&quot;</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">        <span class="p">{</span><span class="nx">viewerId</span> <span class="o">===</span> <span class="nx">reviewer</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">Button</span>
</span><span class="hll">              <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">/review/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">              <span class="p">}}</span>
</span><span class="hll">              <span class="na">text</span><span class="o">=</span><span class="s">&quot;Update&quot;</span>
</span><span class="hll">            <span class="p">/&gt;</span>
</span><span class="hll">          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">)}</span>
</span>      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">text</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">));</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewsList</span><span class="p">;</span>
</pre></div>

<p>The <code>ReviewList</code> component rendered in the <code>Book</code> page component must now also be updated to pass through the new props:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/Book/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">Book</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
             
    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
          <span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">results</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="p">(</span>
            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="hll">              <span class="p">&lt;</span><span class="nt">ReviewsList</span>
</span><span class="hll">                <span class="na">bookId</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span>
</span><span class="hll">                <span class="na">reviews</span><span class="o">=</span><span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">results</span><span class="p">}</span>
</span><span class="hll">                <span class="na">viewerId</span><span class="o">=</span><span class="p">{</span><span class="nx">viewer</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="kc">null</span><span class="p">}</span>
</span><span class="hll">              <span class="p">/&gt;</span>
</span>              <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;italic mt-4&quot;</span><span class="p">&gt;</span>No reviews for this book yet!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
          <span class="p">)}</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Book not found!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Book</span><span class="p">;</span>
</pre></div>

<p>For the remainder of this section, we’ll focus on reworking the <code>ReviewBook</code> page component so that it can serve the dual purposes of submitting new reviews and updating existing reviews. We have already designated a separate route to render the version of this page for updating reviews, but we’ll need to make some adjustments to the user interface so that it’s more applicable to that context. As a first step, if a user is updating their review, then existing values for the rating and the review content should be pre-populated in their respective fields so the user can see what they previously submitted. One way to get these values will be to fetch the individual existing review when the <code>ReviewBook</code> page component renders. And for that, we’ll need another query:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/queries.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">GetReview</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  query GetReview($id: ID!) {</span>
</span><span class="hll"><span class="sb">    review(id: $id) {</span>
</span><span class="hll"><span class="sb">      id</span>
</span><span class="hll"><span class="sb">      rating</span>
</span><span class="hll"><span class="sb">      text</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="c1">// ...</span>
</pre></div>

<p>Now we’ll import the new <code>GetReview</code> query and the <code>UpdateReview</code> mutation into <code>ReviewBook</code>. We’ll also need the <code>useQuery</code> hook from Apollo Client and the <code>useParams</code> hook from React Router to get the review’s ID out of the route so we can use it as the variable value for <code>GetReview</code>. Lastly, we’ll need the <code>Loader</code> component too so we can display it while the query data is fetched from the server.</p>
<p>Next, we’ll call <code>useQuery</code> to fetch the review. We add the <code>skip</code> option to this query to tell Apollo Client that we don’t want to bother fetching the query if the <code>reviewId</code> isn’t available (because that would mean the component is being rendered to create a new review) or if for some reason the <code>viewer</code> isn’t available. After the query is fetched, we use the review’s <code>rating</code> and <code>text</code> fields to pre-populate the values of the form inputs. Lastly, we also pass the <code>UpdateReview</code> mutation into the <code>useMutation</code> hook:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/ReviewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span><span class="p">,</span> <span class="nx">useParams</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useMutation</span><span class="p">,</span> <span class="nx">useQuery</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useState</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>

<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">CreateReview</span><span class="p">,</span> <span class="nx">UpdateReview</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/mutations&quot;</span><span class="p">;</span>
</span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">GetReview</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/queries&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useAuth</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../context/AuthContext&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Button&quot;</span><span class="p">;</span>
<span class="hll"><span class="kr">import</span> <span class="nx">Loader</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Loader&quot;</span><span class="p">;</span>
</span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">ReviewBook</span><span class="p">()</span> <span class="p">{</span>
<span class="hll">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">bookId</span><span class="p">,</span> <span class="nx">reviewId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useParams</span><span class="p">();</span>
</span>  <span class="c1">// ...</span>

<span class="hll">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">loading</span><span class="p">,</span> <span class="nx">error</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useQuery</span><span class="p">(</span><span class="nx">GetReview</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">reviewId</span> <span class="p">},</span>
</span><span class="hll">    <span class="nx">skip</span><span class="o">:</span> <span class="o">!</span><span class="nx">reviewId</span> <span class="o">||</span> <span class="o">!</span><span class="nx">viewer</span><span class="p">,</span>
</span><span class="hll">    <span class="nx">onCompleted</span><span class="o">:</span> <span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">review</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">setRating</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">review</span><span class="p">.</span><span class="nx">rating</span><span class="p">);</span>
</span><span class="hll">        <span class="nx">setText</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">review</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
</span><span class="hll">      <span class="p">}</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">});</span>
</span><span class="hll">
</span>  <span class="kr">const</span> <span class="p">[</span><span class="nx">createReview</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">CreateReview</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">onCompleted</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">updateReview</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">UpdateReview</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">onCompleted</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">});</span>
</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewBook</span><span class="p">;</span>
</pre></div>

<p>Moving further down the component, we’ll update the <code>handleSubmit</code> function so that it conditionally calls the <code>updateReview</code> mutation function if the <code>reviewId</code> is available:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/ReviewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">ReviewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
  <span class="kr">const</span> <span class="nx">handleSubmit</span> <span class="o">=</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nx">reviewId</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">updateReview</span><span class="p">({</span>
</span><span class="hll">        <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">          <span class="nx">input</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">            <span class="nx">id</span><span class="o">:</span> <span class="nx">reviewId</span><span class="p">,</span>
</span><span class="hll">            <span class="nx">rating</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">rating</span><span class="p">),</span>
</span><span class="hll">            <span class="nx">text</span>
</span><span class="hll">          <span class="p">}</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">      <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class="hll">      <span class="p">});</span>
</span><span class="hll">    <span class="p">}</span> else <span class="p">{</span>
</span>      <span class="nx">createReview</span><span class="p">({</span>
        <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">input</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">bookId</span><span class="p">,</span>
            <span class="nx">rating</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">rating</span><span class="p">),</span>
            <span class="nx">reviewerId</span><span class="o">:</span> <span class="nx">viewer</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">text</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">});</span>
<span class="hll">    <span class="p">}</span>
</span>  <span class="p">};</span>
  
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewBook</span><span class="p">;</span>
</pre></div>

<p>Lastly, we’ll add some conditional rendering to the component to show the <code>Loader</code> when the existing review content is fetched and to render the heading text conditionally above the form. We’ll account for any potential error states resulting from the <code>GetReview</code> query by including its <code>error</code> as a condition to check when rendering the <code>PageNotice</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/ReviewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">ReviewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">Loader</span> <span class="na">centered</span> <span class="p">/&gt;;</span>
</span><span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">viewer</span><span class="p">)</span> <span class="p">{</span>
</span>    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
<span class="hll">        <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">{</span><span class="nx">reviewId</span> <span class="o">?</span> <span class="s2">&quot;Update Review&quot;</span> <span class="o">:</span> <span class="s2">&quot;Create a New Review&quot;</span><span class="p">}</span>
</span><span class="hll">        <span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span>        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}&gt;</span>
          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
<span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">||</span> <span class="nx">viewerError</span><span class="p">)</span> <span class="p">{</span>
</span>    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Something went wrong. Please try again!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewBook</span><span class="p">;</span>
</pre></div>

<p>Try out the new and improved <code>ReviewBook</code> component by updating a review that belongs to the currently authenticated user. After a successful mutation, it will behave exactly as the other version of the form does and redirect the user to the book page where they’ll be able to see their updated review.</p>
<h2 id="delete-a-book-review">Delete a Book Review</h2>
<p>As the final piece of the CRUD puzzle for reviews, we’ll implement the <code>deleteReview</code> mutation in the React application. As a first step, we’ll add the new mutation to <code>mutations.js</code>:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/mutations.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">DeleteReview</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  mutation DeleteReview($id: ID!) {</span>
</span><span class="hll"><span class="sb">    deleteReview(id: $id)</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="c1">// ...</span>
</pre></div>

<p>We’ll add a button to trigger this mutation directly under the existing “Update” button for any review that belongs to the authenticated user. That means we’ll need to import the <code>DeleteReview</code> mutation into the <code>ReviewList</code> component and update it with the following code:</p>
<p></p>
<div class="code-context">
<p>client/src/components/ReviewList/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useMutation</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="nx">dayjs</span> <span class="nx">from</span> <span class="s2">&quot;dayjs&quot;</span><span class="p">;</span>

<span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">DeleteReview</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/mutations&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Button&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">ReviewsList</span><span class="p">({</span> <span class="nx">bookId</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">viewerId</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>

<span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">deleteReview</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">DeleteReview</span><span class="p">);</span>
</span>
  <span class="k">return</span> <span class="nx">reviews</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">rating</span><span class="p">,</span> <span class="nx">reviewedOn</span><span class="p">,</span> <span class="nx">reviewer</span><span class="p">,</span> <span class="nx">text</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;pt-10&quot;</span> <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">id</span><span class="p">}&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;sm:flex sm:justify-between mb-4 sm:mb-0&quot;</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">{</span><span class="nx">viewerId</span> <span class="o">===</span> <span class="nx">reviewer</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">Button</span>
<span class="hll">              <span class="na">className</span><span class="o">=</span><span class="s">&quot;block&quot;</span>
</span>              <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">/review/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
              <span class="p">}}</span>
              <span class="na">text</span><span class="o">=</span><span class="s">&quot;Update&quot;</span>
            <span class="p">/&gt;</span>
<span class="hll">            <span class="p">&lt;</span><span class="nt">button</span>
</span><span class="hll">              <span class="na">className</span><span class="o">=</span><span class="s">&quot;block m-auto mt-1 text-sm text-gray-600 hover:text-red-600&quot;</span>
</span><span class="hll">              <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                <span class="nx">deleteReview</span><span class="p">({</span> <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class="hll">                <span class="p">});</span>
</span><span class="hll">              <span class="p">}}</span>
</span><span class="hll">            <span class="p">&gt;</span>
</span><span class="hll">              Delete
</span><span class="hll">            <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span>          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">)}</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">text</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">));</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewsList</span><span class="p">;</span>
</pre></div>

<p>The new “Delete” button should render as follows:</p>
<p><img src="../../images/screenshots/react-app-review-list-action-buttons.png" alt="Update and delete buttons rendered next to a user’s review" /><br />
</p>
<p>To keep the user interface and Apollo Client cache in sync after a review is deleted, we’ll have to use a different approach than we have before. When creating and updating reviews, we took the (somewhat heavy-handed) approach of refetching the book and review data from the GraphQL API when the <code>Book</code> page component reloads after a successful mutation. When deleting a review, the user will be able to take that action directly from the book page, and the deleted review should be removed from the list and the cache instantly when the mutation completes.</p>
<p>To accomplish this, we’ll have to use Apollo Client’s <code>cache.modify</code> method to extract the review reference from the applicable book object and also clean up the orphaned review object. To use this method, we’ll call it from the mutation’s <code>update</code> method (which has access to the <code>cache</code> object as its first parameter) and pass the <code>cache.modify</code> method an object that has an <code>id</code> property with the value of the cache key for the book we want to update, as well as a <code>fields</code> property that instructs Apollo Client how to update the data stored for the <code>reviews</code> field:</p>
<p></p>
<div class="code-context">
<p>client/src/components/ReviewList/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">ReviewsList</span><span class="p">({</span> <span class="nx">bookId</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">viewerId</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>

<span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">deleteReview</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">DeleteReview</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">update</span><span class="o">:</span> <span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">deleteReview</span> <span class="p">}</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">cache</span><span class="p">.</span><span class="nx">modify</span><span class="p">({</span>
</span><span class="hll">        <span class="nx">id</span><span class="o">:</span> <span class="sb">`Book:</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
</span><span class="hll">        <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">          <span class="nx">reviews</span><span class="p">(</span><span class="nx">existingReviewRefs</span><span class="p">,</span> <span class="p">{</span> <span class="nx">readField</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">            <span class="k">return</span> <span class="nx">existingReviewRefs</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
</span><span class="hll">              <span class="nx">reviewRef</span> <span class="p">=&gt;</span> <span class="nx">deleteReview</span> <span class="o">!==</span> <span class="nx">readField</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nx">reviewRef</span><span class="p">)</span>
</span><span class="hll">            <span class="p">);</span>
</span><span class="hll">          <span class="p">}</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">      <span class="p">});</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">});</span>
</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewsList</span><span class="p">;</span>
</pre></div>

<p>Lastly, we’ll use the <code>cache.evict</code> method to remove the review object from the cache too:</p>
<p></p>
<div class="code-context">
<p>client/src/components/ReviewList/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">ReviewsList</span><span class="p">({</span> <span class="nx">bookId</span><span class="p">,</span> <span class="nx">reviews</span><span class="p">,</span> <span class="nx">viewerId</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>

  <span class="kr">const</span> <span class="p">[</span><span class="nx">deleteReview</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span><span class="nx">DeleteReview</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">update</span><span class="o">:</span> <span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">deleteReview</span> <span class="p">}</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">cache</span><span class="p">.</span><span class="nx">modify</span><span class="p">({</span>
        <span class="c1">// ...</span>
      <span class="p">});</span>
<span class="hll">      <span class="nx">cache</span><span class="p">.</span><span class="nx">evict</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="sb">`Review:</span><span class="si">${</span><span class="nx">deleteReview</span><span class="si">}</span><span class="sb">`</span> <span class="p">});</span>
</span>    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ReviewsList</span><span class="p">;</span>
</pre></div>

<p>Now the cache state will match the server and the user interface will be updated when the review is deleted. However, there is a lingering bug in the review list still. If the number of total reviews exceeds the page limit and we try deleting a few reviews, we’ll notice some strange behavior with the pages of results that are displayed on the screen. At this point, we have finally bumped into one of the limitations of offset-based pagination—the paging window may become ambiguous when results are added to or removed in place from the current page. We could attempt to engineer some elaborate client-side workarounds to deal with this limitation, but requiring clients to jump through hoops to consume data from an API wouldn’t be a very GraphQL-like approach to solving this problem.</p>
<p>Ultimately, to support the review deletion feature as designed (and support real-time updates to this list when new reviews are added with subscription operation in Chapter 10) the <code>reviews</code> field on the <code>Book</code> type should be adjusted to support cursor-based pagination. While JSON Server has served us well so far as a mocked REST API for our backing data source, it isn’t well-suited to implementing cursor-based pagination. Working around these limitations to implement cursor-based pagination for the book reviews is outside the scope of this book. Nonetheless, this does serve as an important lesson in how product requirements may necessitate different pagination styles for different fields in a GraphQL API.</p>
<h2 id="create-a-new-book-with-authors">Create a New Book with Authors</h2>
<p>For our final mutation-powered feature, we’ll add a mutation that allows users to submit new books to the Bibliotech catalogue. The form that we’re going to build to create new books will have text input fields for the title, cover image URL, and summary, as well as a select field for the genre. The form will also include a text input for users to provide the name of the book author (or multiple authors, if applicable).</p>
<p>To make this experience as seamless as possible on the front-end, when a user submits a new book we’ll also automatically create any authors that are associated with the book but that don’t exist in <code>db.json</code> yet. Thinking through how to achieve this with our existing GraphQL API, when a user submits the form with the new book details, we would need to do the following:</p>
<ol type="1">
<li>Send a search query to the API for each of the author names listed in the authors input</li>
<li>If a result is returned for any of the authors names, then keep track of the author ID</li>
<li>For any author names that don’t provide a search result, create each of those authors and then keep track of their IDs as well</li>
<li>Finally, send the <code>createBook</code> mutation with the existing author IDs and the new author IDs concatenated together as the <code>authorIds</code> argument value</li>
</ol>
<p>In a REST API world, we may have to live with handling all of this business logic on the client. But we’re building a GraphQL API, so a convoluted client-side scenario such as this is usually a good indication that a new mutation field can be added to simplify this process. What’s more, shifting this logic to the server will make the process less error prone and more performant, as it will no longer be up to individual clients to ensure business rules are adhered to when creating a new book with authors and we can reduce the number of back-and-forth trips between the client and server to carry out the user’s desired action.</p>
<p>Over in the <code>server</code> directory, our first step will be to add a new <code>createBookAndAuthors</code> mutation and a <code>CreateBookAndAuthorsInput</code> Input Object type to the type definitions:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server-express&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="hll"><span class="sb">  &quot;&quot;&quot;</span>
</span><span class="hll"><span class="sb">  Provides data to create a book and any associated authors.</span>
</span><span class="hll"><span class="sb">  &quot;&quot;&quot;</span>
</span><span class="hll"><span class="sb">  input CreateBookAndAuthorsInput {</span>
</span><span class="hll"><span class="sb">    &quot;The names of the authors who wrote the book. Non-existent authors will be created.&quot;</span>
</span><span class="hll"><span class="sb">    authorNames: [String]</span>
</span><span class="hll"><span class="sb">    &quot;&quot;&quot;</span>
</span><span class="hll"><span class="sb">    The URL of the book&#39;s cover image. Covers available via the Open Library Covers API:</span>
</span><span class="hll">
</span><span class="hll"><span class="sb">    https://openlibrary.org/dev/docs/api/covers</span>
</span><span class="hll"><span class="sb">    &quot;&quot;&quot;</span>
</span><span class="hll"><span class="sb">    cover: String</span>
</span><span class="hll"><span class="sb">    &quot;A literary genre to which the book can be assigned.&quot;</span>
</span><span class="hll"><span class="sb">    genre: Genre</span>
</span><span class="hll"><span class="sb">    &quot;A short summary of the book&#39;s content.&quot;</span>
</span><span class="hll"><span class="sb">    summary: String</span>
</span><span class="hll"><span class="sb">    &quot;The title of the book.&quot;</span>
</span><span class="hll"><span class="sb">    title: String!</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll">
</span><span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="sb">    # ...</span>
<span class="hll"><span class="sb">    &quot;Creates a new book and any of its authors that do not yet exist.&quot;</span>
</span><span class="hll"><span class="sb">    createBookAndAuthors(input: CreateBookAndAuthorsInput!): Book!</span>
</span><span class="sb">    # ...</span>
<span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>The data source method we need to help resolve this field will be somewhat complex because it will handle the server-side equivalent of what was outlined in the steps above. However, this code will still be more succinct than what would be required to implement the same logic on the client:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">createBookAndAuthors</span><span class="p">({</span> <span class="nx">authorNames</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="kd">let</span> <span class="nx">authorIds</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nx">authorNames</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="kr">const</span> <span class="nx">authorSearchResults</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">        <span class="nx">authorNames</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">authorName</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/authors?name=</span><span class="si">${</span><span class="nx">authorName</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span>
</span><span class="hll">      <span class="p">);</span>
</span><span class="hll">      <span class="kr">const</span> <span class="nx">existingAuthors</span> <span class="o">=</span> <span class="nx">authorSearchResults</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
</span><span class="hll">      <span class="kr">const</span> <span class="nx">existingAuthorIds</span> <span class="o">=</span> <span class="nx">existingAuthors</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">author</span> <span class="p">=&gt;</span> <span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class="hll">      <span class="nx">authorIds</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">existingAuthorIds</span><span class="p">);</span>
</span><span class="hll">
</span><span class="hll">      <span class="kr">const</span> <span class="nx">authorsToCreate</span> <span class="o">=</span> <span class="nx">existingAuthors</span><span class="p">.</span><span class="nx">length</span>
</span><span class="hll">        <span class="o">?</span> <span class="nx">authorNames</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
</span><span class="hll">            <span class="nx">authorName</span> <span class="p">=&gt;</span>
</span><span class="hll">              <span class="o">!</span><span class="nx">existingAuthors</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">author</span> <span class="p">=&gt;</span> <span class="nx">author</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">authorName</span><span class="p">)</span>
</span><span class="hll">          <span class="p">)</span>
</span><span class="hll">        <span class="o">:</span> <span class="nx">authorNames</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">      <span class="kr">const</span> <span class="nx">newAuthorIds</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class="hll">      <span class="k">if</span> <span class="p">(</span><span class="nx">authorsToCreate</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="kr">const</span> <span class="nx">newAuthors</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">          <span class="nx">authorsToCreate</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">createAuthor</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
</span><span class="hll">        <span class="p">);</span>
</span><span class="hll">        <span class="nx">newAuthors</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">newAuthor</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">          <span class="nx">newAuthorIds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newAuthor</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class="hll">        <span class="p">});</span>
</span><span class="hll">      <span class="p">}</span>
</span><span class="hll">      <span class="nx">authorIds</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">newAuthorIds</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">createBook</span><span class="p">({</span> <span class="nx">authorIds</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span> <span class="p">});</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Next, we’ll create a resolver for the new <code>createBookAndAuthors</code> mutation field:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="hll">    <span class="nx">createBookAndAuthors</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">}</span>, <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createBookAndAuthors</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span>
</span>    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>Back over on the client, we can add a <code>CreateBookAndAuthors</code> mutation now:</p>
<p></p>
<div class="code-context">
<p>client/src/graphql/mutations.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="hll"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">CreateBookAndAuthors</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
</span><span class="hll"><span class="sb">  mutation CreateBookAndAuthors($input: CreateBookAndAuthorsInput!) {</span>
</span><span class="hll"><span class="sb">    createBookAndAuthors(input: $input) {</span>
</span><span class="hll"><span class="sb">      id</span>
</span><span class="hll"><span class="sb">      authors {</span>
</span><span class="hll"><span class="sb">        name</span>
</span><span class="hll"><span class="sb">      }</span>
</span><span class="hll"><span class="sb">      cover</span>
</span><span class="hll"><span class="sb">      genre</span>
</span><span class="hll"><span class="sb">      title</span>
</span><span class="hll"><span class="sb">    }</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll"><span class="sb">`</span><span class="p">;</span>
</span><span class="hll">
</span><span class="c1">// ...</span>
</pre></div>

<p>Next, we’ll create a new page component directory called <code>NewBook</code> in <code>client/src/pages</code> to render the form that will be responsible for capturing new book submissions. In its <code>index.js</code> file, we’ll add the following initial code for the form and its fields:</p>
<p></p>
<div class="code-context">
<p>client/src/pages/NewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">useHistory</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router-dom&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useMutation</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;@apollo/client&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useState</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react&quot;</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">CreateBookAndAuthors</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../graphql/mutations&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">useAuth</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;../../context/AuthContext&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Button</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Button&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MainLayout</span> <span class="nx">from</span> <span class="s2">&quot;../../components/MainLayout&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">PageNotice</span> <span class="nx">from</span> <span class="s2">&quot;../../components/PageNotice&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Select</span> <span class="nx">from</span> <span class="s2">&quot;../../components/Select&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">TextInput</span> <span class="nx">from</span> <span class="s2">&quot;../../components/TextInput&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">NewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">title</span><span class="p">,</span> <span class="nx">setTitle</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">authors</span><span class="p">,</span> <span class="nx">setAuthors</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">cover</span><span class="p">,</span> <span class="nx">setCover</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">genre</span><span class="p">,</span> <span class="nx">setGenre</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">summary</span><span class="p">,</span> <span class="nx">setSummary</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">titleError</span><span class="p">,</span> <span class="nx">setTitleError</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">();</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">viewer</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">viewerError</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useAuth</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">useHistory</span><span class="p">();</span>

  <span class="kr">const</span> <span class="nx">handleSubmitBook</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="c1">// Check for an empty title field and send the mutation here...</span>
  <span class="p">};</span>

  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">viewer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white p-8 shadow-xl&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>Create a New Book<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmitBook</span><span class="p">}&gt;</span>
          <span class="p">&lt;</span><span class="nt">TextInput</span>
            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6 w-full sm:w-3/5 md:w-1/2&quot;</span>
            <span class="na">error</span><span class="o">=</span><span class="p">{</span><span class="nx">titleError</span><span class="p">}</span>
            <span class="na">id</span><span class="o">=</span><span class="s">&quot;title&quot;</span>
            <span class="na">inputWidthClass</span><span class="o">=</span><span class="s">&quot;w-full&quot;</span>
            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Title *&quot;</span>
            <span class="na">name</span><span class="o">=</span><span class="s">&quot;title&quot;</span>
            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="nx">setTitle</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}}</span>
            <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter the book&#39;s title&quot;</span>
            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">title</span><span class="p">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">TextInput</span>
            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6 w-full sm:w-3/5 md:w-1/2&quot;</span>
            <span class="na">id</span><span class="o">=</span><span class="s">&quot;cover&quot;</span>
            <span class="na">inputWidthClass</span><span class="o">=</span><span class="s">&quot;w-full&quot;</span>
            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Cover Image URL&quot;</span>
            <span class="na">name</span><span class="o">=</span><span class="s">&quot;cover&quot;</span>
            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="nx">setCover</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}}</span>
            <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Provide an URL for the book&#39;s cover image&quot;</span>
            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">cover</span><span class="p">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">TextInput</span>
            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6 w-full sm:w-3/5 md:w-1/2&quot;</span>
            <span class="na">id</span><span class="o">=</span><span class="s">&quot;author&quot;</span>
            <span class="na">inputWidthClass</span><span class="o">=</span><span class="s">&quot;w-full&quot;</span>
            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Author (separate multiple authors with commas)&quot;</span>
            <span class="na">name</span><span class="o">=</span><span class="s">&quot;author&quot;</span>
            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="nx">setAuthors</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}}</span>
            <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Enter the author&#39;s full name&quot;</span>
            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">authors</span><span class="p">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">TextInput</span>
            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6 w-full sm:w-3/5 md:w-1/2&quot;</span>
            <span class="na">id</span><span class="o">=</span><span class="s">&quot;summary&quot;</span>
            <span class="na">inputWidthClass</span><span class="o">=</span><span class="s">&quot;w-full&quot;</span>
            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Summary&quot;</span>
            <span class="na">name</span><span class="o">=</span><span class="s">&quot;summary&quot;</span>
            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="nx">setSummary</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}}</span>
            <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Provide a short summary of the book&#39;s content&quot;</span>
            <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">summary</span><span class="p">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">Select</span>
            <span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-6 w-full sm:w-3/5 md:w-1/2&quot;</span>
            <span class="na">label</span><span class="o">=</span><span class="s">&quot;Genre&quot;</span>
            <span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="nx">setGenre</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}}</span>
            <span class="na">options</span><span class="o">=</span><span class="p">{[</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Choose one...&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;ADVENTURE&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Children&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;CHILDREN&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Classics&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;CLASSICS&quot;</span> <span class="p">}</span>,
              <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Comic Book / Graphic Novel&quot;</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;COMIC_GRAPHIC_NOVEL&quot;</span>
              <span class="p">}</span>,
              <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Detective / Mystery&quot;</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;DETECTIVE_MYSTERY&quot;</span>
              <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Dystopia&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;DYSTOPIA&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;FANTASY&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Horror&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;HORROR&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Humor&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;HUMOR&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Non-Fiction&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;NON_FICTION&quot;</span> <span class="p">}</span>,
              <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Science Fiction&quot;</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;SCIENCE_FICTION&quot;</span>
              <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Romance&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;ROMANCE&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Thriller&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;THRILLER&quot;</span> <span class="p">}</span>,
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Western&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;WESTERN&quot;</span> <span class="p">}</span>
            <span class="p">]}</span>
            selectWidthClass=&quot;w-full sm:w-3/4&quot;
            value=<span class="p">{</span><span class="nx">genre</span><span class="p">}</span>
          <span class="o">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-center&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">Button</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;mr-2 mt-4&quot;</span> <span class="na">primary</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">viewerError</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Something went wrong. Please try again!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">NewBook</span><span class="p">;</span>
</pre></div>

<p>Next, we’ll use the <code>useMutation</code> hook to configure the <code>CreateBookAndAuthors</code> mutation. In its <code>onCompleted</code> option, we’ll push the user to the route of the newly created book:</p>
<p></p>
<div class="code-context">
<p>client/src/components/NewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">NewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

<span class="hll">  <span class="kr">const</span> <span class="p">[</span><span class="nx">createBookAndAuthors</span><span class="p">,</span> <span class="p">{</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">mutationError</span> <span class="p">}]</span> <span class="o">=</span> <span class="nx">useMutation</span><span class="p">(</span>
</span><span class="hll">    <span class="nx">CreateBookAndAuthors</span><span class="p">,</span>
</span><span class="hll">    <span class="p">{</span>
</span><span class="hll">      <span class="nx">onCompleted</span><span class="o">:</span> <span class="p">({</span> <span class="nx">createBookAndAuthors</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`/book/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">      <span class="p">}</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">);</span>
</span><span class="hll">  
</span>  <span class="kr">const</span> <span class="nx">handleSubmitBook</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="c1">// Check for an empty title field and send the mutation here...</span>
  <span class="p">};</span>
  
  <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">viewer</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mutationError</span> <span class="o">||</span> <span class="nx">viewerError</span><span class="p">)</span> <span class="p">{</span>
</span>    <span class="nx">content</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">PageNotice</span> <span class="na">text</span><span class="o">=</span><span class="s">&quot;Something went wrong. Please try again!&quot;</span> <span class="p">/&gt;;</span>
  <span class="p">}</span>

  return <span class="p">&lt;</span><span class="nt">MainLayout</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">}&lt;/</span><span class="nt">MainLayout</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">NewBook</span><span class="p">;</span>
</pre></div>

<p>We must also update the <code>handleSubmitBook</code> function to call the mutation. Because the title is a required field, we first check if a <code>title</code> value exists and set an error on the field if it doesn’t:</p>
<p></p>
<div class="code-context">
<p>client/src/components/NewBook/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">NewBook</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="kr">const</span> <span class="nx">handleSubmitBook</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="hll">    <span class="nx">setTitleError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">setTitleError</span><span class="p">(</span><span class="s2">&quot;This field is required&quot;</span><span class="p">);</span>
</span><span class="hll">      <span class="k">return</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="nx">createBookAndAuthors</span><span class="p">({</span>
</span><span class="hll">      <span class="nx">variables</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">input</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">          <span class="nx">authorNames</span><span class="o">:</span> <span class="nx">authors</span> <span class="o">?</span> <span class="nx">authors</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s*,\s*/</span><span class="p">)</span> <span class="o">:</span> <span class="p">[],</span>
</span><span class="hll">          <span class="nx">title</span><span class="p">,</span>
</span><span class="hll">          <span class="p">...(</span><span class="nx">cover</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">cover</span> <span class="p">}),</span>
</span><span class="hll">          <span class="p">...(</span><span class="nx">genre</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">genre</span> <span class="p">}),</span>
</span><span class="hll">          <span class="p">...(</span><span class="nx">summary</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">summary</span> <span class="p">})</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">      <span class="p">}</span>
</span><span class="hll">    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class="hll">    <span class="p">});</span>
</span>  <span class="p">};</span>
  
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">NewBook</span><span class="p">;</span>
</pre></div>

<p>To view our new form, we’ll render it at the <code>/book/new</code> route:</p>
<p></p>
<div class="code-context">
<p>client/src/router/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Switch</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;react-router&quot;</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="hll"><span class="kr">import</span> <span class="nx">NewBook</span> <span class="nx">from</span> <span class="s2">&quot;../pages/NewBook&quot;</span><span class="p">;</span>
</span><span class="c1">// ...</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Routes</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">Switch</span><span class="p">&gt;</span>
      <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="hll">      <span class="p">&lt;</span><span class="nt">PrivateRoute</span> <span class="na">exact</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;/book/new&quot;</span> <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">NewBook</span><span class="p">}</span> <span class="p">/&gt;</span>
</span>      <span class="p">&lt;</span><span class="nt">PublicRoute</span> <span class="na">exact</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;/book/:id&quot;</span> <span class="na">component</span><span class="o">=</span><span class="p">{</span><span class="nx">Book</span><span class="p">}</span> <span class="p">/&gt;</span>
      <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">Switch</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Routes</span><span class="p">;</span>
</pre></div>

<p>The completed “Create a New Book” form should render like this:</p>
<p><img src="../../images/screenshots/react-app-new-book-form.png" alt="Form for submitting new books with authors" /><br />
</p>
<p>As a final step, let’s add an “Add Book” link to the <code>NavBar</code> component so authenticated users can easily access this page from anywhere in the application:</p>
<p></p>
<div class="code-context">
<p>client/src/components/NavBar/index.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kd">function</span> <span class="nx">NavBar</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">header</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-white border-b border-gray-200 border-solid&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-center justify-between mx-auto max-w-screen-lg px-8 py-8 w-full&quot;</span><span class="p">&gt;</span>
        <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-center sm:justify-end mt-2 sm:mt-0&quot;</span><span class="p">&gt;</span>
           <span class="p">{</span><span class="nx">isAuthenticated</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
<span class="hll">            <span class="p">&lt;&gt;</span>
</span>              <span class="p">&lt;</span><span class="nt">Link</span> <span class="na">to</span><span class="o">=</span><span class="s">&quot;/home&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold mr-4 text-sm sm:text-base text-red-600&quot;</span><span class="p">&gt;</span>
                  My Library
                <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">Link</span><span class="p">&gt;</span>
<span class="hll">              <span class="p">&lt;</span><span class="nt">Link</span> <span class="na">to</span><span class="o">=</span><span class="s">&quot;/book/new&quot;</span><span class="p">&gt;</span>
</span><span class="hll">                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold mr-4 text-sm sm:text-base text-red-600&quot;</span><span class="p">&gt;</span>
</span><span class="hll">                  Add Book
</span><span class="hll">                <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span><span class="hll">              <span class="p">&lt;/</span><span class="nt">Link</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;/&gt;</span>
</span>          <span class="p">)}</span>
          <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">NavBar</span><span class="p">;</span>
</pre></div>

<p>To wrap up this chapter, try creating a new book with new authors to confirm that the form is functioning as expected.</p>
<h2 id="summary">Summary</h2>
<p>In this chapter, we learned about some of Apollo Client’s more advanced features, including how to interact with the normalized cache when fetching additional pages of results and when running mutations. We paginated lists of books on the index and home pages, and also paginated lists of reviews on the book pages. We created mutations for adding and removing books from a library, as well as creating, updating, and deleting reviews. We also adjusted our API to accommodate a product requirement to allow users to create new books and any applicable, non-existent authors from a single form.</p>
<p>We have now built out most of the features for Bibliotech’s React application, but we still have one more finishing touch to add. In the next chapter, we’ll learn how to add new reviews in real-time to books pages using GraphQL subscriptions.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://www.apollographql.com/docs/react/caching/cache-configuration/#data-normalization">https://www.apollographql.com/docs/react/caching/cache-configuration/#data-normalization</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<footer>
<p class="copyright">Copyright © 2021 <a href="https://8bit.press/">8-Bit Press Inc.</a> All rights reserved.</p>
</footer>
</div>
</div>
<script>
(function () {
  "use strict";

  const chapter = document.getElementById("chapter");

  // Set width of fixed-position chapter navigation based on parent
  function setChapterNavWidth() {
    const chapterNav = document.getElementsByClassName("chapter-nav")[0];
    let { width: chapterWidth } = chapter.getBoundingClientRect();
    chapterNav.setAttribute(
      "style",
      `width: ${chapterWidth >= 960 ? chapterWidth * 0.3 + 36 + "px" : "100%"}`
    );
  }

  setChapterNavWidth();
  window.addEventListener("resize", setChapterNavWidth);

  // Open and close the book navigation in the masthead
  const openMastheadButton = document.getElementById("masthead-open");
  const closeMastheadButton = document.getElementById("masthead-close");
  const masthead = document.getElementById("masthead");

  openMastheadButton.addEventListener("click", function (event) {
    event.stopPropagation();
    masthead.style.marginLeft = "0px";
  });

  closeMastheadButton.addEventListener("click", function () {
    masthead.style.marginLeft = "-100%";
  });

  chapter.addEventListener("click", function () {
    if (masthead.style.marginLeft === "0px") {
      masthead.style.marginLeft = "-100%";
    }
  });

  // Add "Copy" button to code snippets
  // Reference: https://tomspencer.dev/blog/2018/09/14/adding-click-to-copy-buttons-to-a-hugo-powered-blog/
  if (!document.queryCommandSupported("copy")) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.textContent = msg;
    setTimeout(function () {
      el.textContent = "Copy";
    }, 1000);
  }

  function selectText(node) {
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    const copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn";
    copyBtn.textContent = "Copy";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener("click", function () {
      try {
        const selection = selectText(codeEl);
        document.execCommand("copy");
        selection.removeAllRanges();

        flashCopyMessage(copyBtn, "Copied!");
      } catch (e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, "Failed :'(");
      }
    });

    containerEl.appendChild(copyBtn);
  }

  // Add copy button to code blocks
  var highlightBlocks = document.getElementsByClassName("highlight");
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>
</body>
</html>