<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="../../images/favicon.ico" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mandi Wise" />
  <title>Get Going with GraphQL</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="../../css/web.min.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="masthead">
<div class="close-button-wrapper">
<button id="masthead-close" type="button"><span>Close</span></button>
</div>
<header id="title-block-header">
<h1 class="title">Get Going with GraphQL</h1>
<p class="subtitle">Learn How to Build JavaScript Applications with Apollo Server and Apollo Client</p>
<p class="author">Mandi Wise</p>
</header>
<nav class="book-nav">
<ol class="front-matter-content">
<li><a href="../preface/index.html">Preface</a></li>
</ol>
<ol class="main-matter-content">
<li><a href="../chapter-01/index.html">Up and Running with GraphQL and Apollo Server</a></li>
<li><a href="../chapter-02/index.html">More on Queries</a></li>
<li><a href="../chapter-03/index.html">Mutating Data</a></li>
<li><a href="../chapter-04/index.html">Pagination and Search Queries</a></li>
<li><a href="../chapter-05/index.html">Documentation, Custom Scalars, and Custom Directives</a></li>
<li><a href="../chapter-06/index.html">Authentication and Authorization</a></li>
<li><a href="../chapter-07/index.html">React App Set-up</a></li>
<li><a href="../chapter-08/index.html">Apollo Client with User Authentication</a></li>
<li><a href="../chapter-09/index.html">Pagination, Mutations, and the Apollo Client Cache</a></li>
<li><a href="../chapter-10/index.html">Real-time Updates with Subscriptions</a></li>
</ol>
<ol class="back-matter-content">
<li><a href="../appendix-a/index.html">Appendix A</a></li>
<li><a href="../about-the-author/index.html">About the Author</a></li>
<li><a href="../changelog/index.html">Changelog</a></li>
</ol>
<img src="../../images/8bp-logo-white.svg" class="logo" alt="8-Bit Press Inc. logo" />
</nav>
</div>
<div id="chapter">
<div class="chapter-nav">
<nav id="TOC" role="doc-toc">
<button id="masthead-open" type="button"><span>Book Navigation</span></button>
<h2 id="toc-title">Contents</h2>
<ul>
<li><a href="#mutating-data">Chapter 3: Mutating Data</a>
<ul>
<li><a href="#mutations-how-we-write-data-via-a-graphql-api">Mutations: How We Write Data via a GraphQL API</a></li>
<li><a href="#create-an-author">Create an Author</a></li>
<li><a href="#create-a-book-with-an-input-type">Create a Book with an Input Type</a></li>
<li><a href="#create-a-review-with-custom-error-handling">Create a Review with Custom Error Handling</a></li>
<li><a href="#update-or-delete-a-review">Update or Delete a Review</a></li>
<li><a href="#sign-up-a-new-user">Sign Up a New User</a></li>
<li><a href="#update-a-users-library">Update a User’s Library</a></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>
</div>
<div class="content">
<h1 id="mutating-data">Chapter 3: Mutating Data</h1>
<div class="boxout">
<p>In this chapter, we will:</p>
<ul>
<li>Write data via a GraphQL API using mutations</li>
<li>Add mutations to create authors and books</li>
<li>Using an Input Object type to handle complex field arguments</li>
<li>Add mutations to create reviews and handle errors when a user tries to review the same book twice</li>
<li>Add mutations that allow users to update and delete their reviews</li>
<li>Sign up a new user with a mutation and validate unique username and email values</li>
<li>Add mutations to add and remove books from a user’s library</li>
</ul>
</div>
<h2 id="mutations-how-we-write-data-via-a-graphql-api">Mutations: How We Write Data via a GraphQL API</h2>
<p>After some considerable practice reading data using GraphQL queries, it’s time to move on to writing data. In GraphQL speak, that means that we will be creating and running mutation operations. Mutation syntax largely resembles what we have become accustomed to with queries, but we’ll define mutations on the <code>mutation</code> root operation type, or in other words, as fields on the <code>Mutation</code> Object type.</p>
<p>As with queries, when we define mutations for a GraphQL API we want to keep client use cases in mind. That means that as we add fields to the <code>Mutation</code> Object type, we will focus on creating mutations that directly support the actions users want to take inside of the React application, rather than blindly replicating what can be done with the Bibliotech REST API endpoints (remember, we want to focus on designing around product experiences and keep those back-end implementation details out of the schema).</p>
<p>And as a further best practice, we will strive to create finer-grained mutations that facilitate specific user actions. And to that end, by the conclusion of this chapter we will have added individual mutations that create authors, books, reviews, and users; update or delete reviews; add or remove authors from a book, and; add or remove books from a user’s library.</p>
<div class="boxout">
<p><strong>Mo Mutations Mo Problems?</strong></p>
<p>If the thought of adding a large number of highly specific mutations (and queries) to a GraphQL API makes you concerned that the schema may become bloated over time with unused fields as client needs evolve, then fear not! GraphQL is designed to support an API’s continuous evolution (without versioning) and there’s a built-in way to flag deprecate fields.</p>
<p>GraphQL-focused observability tools also help you understand how fields in your API are being used, what clients are using them, and how recently they have been used so that deprecated fields may be safely retired from the API.</p>
</div>
<h2 id="create-an-author">Create an Author</h2>
<p>Our first mutation will allow us to create a new author. To do that we must update the type definitions to include the <code>Mutation</code> Object type and add the <code>createAuthor</code> mutation as its first field. This mutation will have a single <code>name</code> argument that takes a non-null <code>String</code> and the field output type will be a non-null <code>Author</code> (meaning that after an author is created, we can expect to receive data about that new author back in the response):</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>
<span class="hll">
</span><span class="hll"><span class="sb">  type Mutation {</span>
</span><span class="hll"><span class="sb">    createAuthor(name: String!): Author!</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>Note that using non-null mutation arguments can help clients understand exactly what data is mandatory when they submit a mutation operation and also help eliminate the need to do runtime validation manually when a specific argument is required to complete a given mutation. Next, we need to add a new method to the <code>JsonServerApi</code> data source. For the first time, we will use the <code>post</code> method exposed in its parent class to create a new user:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">RESTDataSource</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-datasource-rest&quot;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="hll">  
</span><span class="hll">  <span class="nx">createAuthor</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/authors&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">});</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>When we send this <code>POST</code> request to the running JSON Server will see that a new author record has been written to the <code>db.json</code> file, and thus will be queryable by the GraphQL API. To finish wiring up this mutation, we’ll add a <code>Mutation</code> key to the <code>resolvers</code> object and call the new method inside a <code>createAuthor</code> resolver, passing through the <code>name</code> argument’s value:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Query</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="hll">  <span class="p">},</span>
</span><span class="hll">  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">createAuthor</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createAuthor</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span>  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>To run a mutation we must now use the <code>mutation</code> keyword instead of the <code>query</code> keyword in the operation document, but the rest of the syntax will be the same. We’ll add <code>id</code> and <code>name</code> fields as selections so that we receive those values in the response after the mutation completes. Try running the following mutation from Explorer to create a new book:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">CreateAuthor</span><span class="p">(</span><span class="nv">$name</span><span class="p">:</span> <span class="k">String</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">createAuthor</span><span class="p">(</span>name: <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">id</span>
    <span class="k">name</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Ursula K. Le Guin&quot;</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;createAuthor&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Ursula K. Le Guin&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="create-a-book-with-an-input-type">Create a Book with an Input Type</h2>
<p>Onward to books! We’ll follow similar steps to add a mutation to create a new book now. However, adding a new book to Bibliotech is a bit more complex because a new book must have a title and it also may have any number of authors assigned (based on the authors’ IDs) and an optional cover image URL. Adding a <code>createBook</code> mutation with those four arguments would look like this:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="sb">    createAuthor(name: String!): Author!</span>
<span class="hll"><span class="sb">    createBook(</span>
</span><span class="hll"><span class="sb">      authorIds: [ID]</span>
</span><span class="hll"><span class="sb">      cover: String</span>
</span><span class="hll"><span class="sb">      summary: String</span>
</span><span class="hll"><span class="sb">      title: String!</span>
</span><span class="hll"><span class="sb">    ): Book!</span>
</span><span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>This approach will certainly work when handling multiple arguments, but there’s a tidier way that we can pass a complex value into a field called an <em>Input Object</em>—the third kind of named type that we will incorporate into our schema. We create an Input Object type much as we do a regular Object type with any combination of nullable, non-null, and list fields, but we use the <code>input</code> keyword in front of it instead:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="hll"><span class="sb"> input CreateBookInput {</span>
</span><span class="hll"><span class="sb">    authorIds: [ID]</span>
</span><span class="hll"><span class="sb">    cover: String</span>
</span><span class="hll"><span class="sb">    summary: String</span>
</span><span class="hll"><span class="sb">    title: String!</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll">
</span><span class="sb">  # ...</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>We can then rewrite the <code>createBook</code> mutation as follows:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="sb">    createAuthor(name: String!): Author!</span>
<span class="hll"><span class="sb">    createBook(input: CreateBookInput!): Book!</span>
</span><span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>Next, we need to add a <code>createBook</code> method to the data source for use in the corresponding resolver. This method will be more complex than the <code>createAuthor</code> one is because we need to create the book object in <code>db.json</code> and also create <code>bookAuthor</code> objects to join the book to all of its authors:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">RESTDataSource</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-datasource-rest&quot;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="hll">  
</span><span class="hll">  <span class="nx">async</span> <span class="nx">createBook</span><span class="p">({</span> <span class="nx">authorIds</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">summary</span><span class="p">,</span> <span class="nx">title</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/books&quot;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">      <span class="p">...(</span><span class="nx">cover</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">cover</span> <span class="p">}),</span>
</span><span class="hll">      <span class="p">...(</span><span class="nx">summary</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">summary</span> <span class="p">}),</span>
</span><span class="hll">      <span class="nx">title</span>
</span><span class="hll">    <span class="p">});</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nx">authorIds</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">        <span class="nx">authorIds</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">authorId</span> <span class="p">=&gt;</span>
</span><span class="hll">          <span class="k">this</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/bookAuthors&quot;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">            <span class="nx">authorId</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">authorId</span><span class="p">),</span>
</span><span class="hll">            <span class="nx">bookId</span><span class="o">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">id</span>
</span><span class="hll">          <span class="p">})</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="hll">      <span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">        
</span><span class="hll">    <span class="k">return</span> <span class="nx">book</span><span class="p">;</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Now we’ll set up the <code>createBook</code> resolver, passing through the <code>input</code> argument directly into the data source method:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">createAuthor</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createAuthor</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
<span class="hll">    <span class="p">},</span>
</span><span class="hll">    <span class="nx">createBook</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createBook</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>Before moving on, try running the new mutation to confirm that it works as expected:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">CreateBook</span><span class="p">(</span><span class="nv">$input</span><span class="p">:</span> <span class="k">CreateBookInput</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">createBook</span><span class="p">(</span>input: <span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">id</span>
    <span class="k">cover</span>
    <span class="k">title</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;authorIds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="nt">&quot;cover&quot;</span><span class="p">:</span> <span class="s2">&quot;http://covers.openlibrary.org/b/isbn/038051284X-L.jpg&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Dispossessed&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;createBook&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;cover&quot;</span><span class="p">:</span> <span class="s2">&quot;http://covers.openlibrary.org/b/isbn/038051284X-L.jpg&quot;</span><span class="p">,</span>
      <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Dispossessed&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="create-a-review-with-custom-error-handling">Create a Review with Custom Error Handling</h2>
<p>We can create authors and books now, but we also need a way for user’s to add new reviews to books. Unlike with our previous mutations, there’s an additional consideration when adding new reviews to ensure that each user can only submit one review per book. And to enhance user experience in the client application, we will provide a custom message in the GraphQL response that describes the runtime error so users may better understand why their request failed.</p>
<p>As a first step, we’ll add a <code>CreateReviewInput</code> Input Object and <code>createReview</code> field on the <code>Mutation</code> type:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="hll"><span class="sb">  input CreateReviewInput {</span>
</span><span class="hll"><span class="sb">    bookId: ID!</span>
</span><span class="hll"><span class="sb">    rating: Int!</span>
</span><span class="hll"><span class="sb">    reviewerId: ID!</span>
</span><span class="hll"><span class="sb">    text: String</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll">
</span><span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="sb">    # ...</span>
<span class="hll"><span class="sb">    createReview(input: CreateReviewInput!): Review!</span>
</span><span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>In the code above, note that we don’t include a <code>reviewedOn</code> field in the <code>CreateReviewInput</code> because the time will be calculated automatically on the server instead of depending on the client to send this value. To that end, we’ll create a new method in the <code>JsonServerApi</code> data source to facilitate review creation. Inside of this method, we will throw an error if a user attempts to create a second review for a book. To do that, we have to check the <code>/reviews</code> endpoint to see if a review already exists with <code>bookId</code> and <code>userId</code> field values that match the review to be created. If we find an existing review, then we’ll throw an error so the mutation does not complete.</p>
<p>Before we proceed with writing the code, we should explore the topic of error handling in GraphQL responses first. If you have previously submitted an operation with an incorrect field name in the document, then you may have already encountered GraphQL’s approach to handling errors in responses. When a response contains errors, information about that error will be returned under and <code>errors</code> key in the response. For example, if you try to send an <code>author</code> query with an erroneous field added to it, then you will see this output:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;errors&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;Cannot query field \&quot;firstName\&quot; on type \&quot;Author\&quot;.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;locations&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;line&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
          <span class="s2">&quot;column&quot;</span><span class="o">:</span> <span class="mi">5</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="s2">&quot;extensions&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="o">:</span> <span class="s2">&quot;GRAPHQL_VALIDATION_FAILED&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exception&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;stacktrace&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="c1">// ...</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="kc">null</span>
<span class="p">}</span>
</pre></div>

<p>There are a few interesting things to note in this response. First, at a minimum, a GraphQL response that contains any errors will list each instance of an error under the <code>errors</code> key and each error will have a <code>message</code> key containing some information about what went wrong. Optionally, a <code>locations</code> key may be included for each error to indicate where the error occurred in the GraphQL document.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>An <code>extensions</code> key may also be included with additional information about the error. Apollo Server will provide us with an error <code>code</code> and an <code>exception</code> with a stack trace for the error under this key. Note that for security reasons, stack traces will be unavailable in the response if Apollo Server’s <code>debug</code> option is set to <code>false</code> or the <code>NODE_ENV</code> environment variable is set to <code>test</code> or <code>production</code>.</p>
<p>A final noteworthy point about this example is that there are both <code>errors</code> and <code>data</code> keys in the response. While the <code>data</code> value is <code>null</code> here, GraphQL has a unique feature in that it is possible to send responses that contain errors and partial data depending on what kind of error occurred.</p>
<p>We could throw a standard JavaScript <code>Error</code> inside of our data source method to trigger an error response, but Apollo Server also has several custom error types built in to help improve communication to clients about what kind of error occurred. These errors include an <code>AuthenticationError</code>, a <code>ForbiddenError</code>, a <code>UserInputError</code>, and a general <code>ApolloError</code>. Using these errors will dictate what value is provided for the <code>code</code> key in the error response and also allow you to add additional keys under the <code>exception</code> if needed.</p>
<p>For our purposes, will import and use the <code>ForbiddenError</code> to warn clients that the request failed because the user already created a review for that book:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ForbiddenError</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">RESTDataSource</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-datasource-rest&quot;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="hll">  
</span><span class="hll">  <span class="nx">async</span> <span class="nx">createReview</span><span class="p">({</span> <span class="nx">bookId</span><span class="p">,</span> <span class="nx">rating</span><span class="p">,</span> <span class="nx">reviewerId</span><span class="p">,</span> <span class="nx">text</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">existingReview</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span>
</span><span class="hll">      <span class="sb">`/reviews?bookId=</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">&amp;userId=</span><span class="si">${</span><span class="nx">reviewerId</span><span class="si">}</span><span class="sb">`</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nx">existingReview</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">throw</span> <span class="k">new</span> <span class="nx">ForbiddenError</span><span class="p">(</span><span class="s2">&quot;Users can only submit one review per book&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/reviews&quot;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">      <span class="p">...(</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">text</span> <span class="p">}),</span>
</span><span class="hll">      <span class="nx">bookId</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">bookId</span><span class="p">),</span>
</span><span class="hll">      <span class="nx">createdAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
</span><span class="hll">      <span class="nx">rating</span><span class="p">,</span>
</span><span class="hll">      <span class="nx">userId</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">reviewerId</span><span class="p">)</span>
</span><span class="hll">    <span class="p">});</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Next, we’ll add the <code>createReview</code> mutation in <code>resolvers.js</code>:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">createBook</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createBook</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
<span class="hll">    <span class="p">},</span>
</span><span class="hll">    <span class="nx">createReview</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createReview</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>Let’s take the new <code>createReview</code> mutation for a spin. Try running the operation:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">CreateReview</span><span class="p">(</span><span class="nv">$input</span><span class="p">:</span> <span class="k">CreateReviewInput</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">createReview</span><span class="p">(</span>input: <span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">id</span>
    <span class="k">rating</span>
    <span class="k">text</span>
    <span class="k">reviewedOn</span>
    <span class="k">book</span> <span class="p">{</span>
      <span class="k">title</span>
    <span class="p">}</span>
    <span class="k">reviewer</span> <span class="p">{</span>
      <span class="k">name</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;bookId&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rating&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&quot;reviewerId&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;What a page turner!&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;createReview&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;rating&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;What a page turner!&quot;</span><span class="p">,</span>
      <span class="nt">&quot;reviewedOn&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-02-22T11:37:48.308Z&quot;</span><span class="p">,</span>
      <span class="nt">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Dispossessed&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;reviewer&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Liddell&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Now try running the same mutation a second time. You will see the custom <code>"Users can only submit one review per book"</code> error message in the response, as well as the <code>FORBIDDEN</code> code. GraphQL features such as these will make it much easier to design better user experiences around error handling when we build the React application in later chapters.</p>
<h2 id="update-or-delete-a-review">Update or Delete a Review</h2>
<p>The new Bibliotech React application will also allow users to update and delete reviews that they previously created, so in this section, we’ll add mutations for both. The <code>updateReview</code> mutation will allow users to update both the rating and the review text. Particularly when adding update-related mutations to a schema, it’s important to pause and consider what the client use cases for the mutations will be. It’s often wise to avoid generic catch-all mutations to facilitate any variety of updates a client may need to run on an existing resource in a database. Instead, it’s better to add finer-grained mutations that are tailored around specific use cases.</p>
<p>For the <code>updateReview</code> mutation, it will always be the case that the user is prompted to update both the <code>rating</code> and the optional <code>text</code> field together, so it will make sense to handle both of these values in a single mutation rather than two mutations that allow clients to send updated values for each field individually. We’ll need an <code>UpdateReviewInput</code> type to support this mutation with non-null <code>id</code> and <code>rating</code> fields and a nullable <code>text</code> field. We’ll also add a <code>deleteReview</code> mutation that accepts a single <code>id</code> argument to identify the review to be deleted and that outputs the same ID value to indicate if the deletion operation was successful:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>
<span class="sb">  </span>
<span class="hll"><span class="sb">  input UpdateReviewInput {</span>
</span><span class="hll"><span class="sb">    id: ID!</span>
</span><span class="hll"><span class="sb">    rating: Int!</span>
</span><span class="hll"><span class="sb">    text: String</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll">
</span><span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="sb">    # ...</span>
<span class="hll"><span class="sb">    deleteReview(id: ID!): ID!</span>
</span><span class="hll"><span class="sb">    updateReview(input: UpdateReviewInput!): Review!</span>
</span><span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>Next, we need to add some new methods to the <code>JsonServerApi</code> data source that make <code>patch</code> and <code>delete</code> requests to the Bibliotech REST API:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="hll">  
</span><span class="hll">  <span class="nx">updateReview</span><span class="p">({</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">rating</span><span class="p">,</span> <span class="nx">text</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="sb">`reviews/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">      <span class="nx">rating</span><span class="p">,</span>
</span><span class="hll">      <span class="p">...(</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">text</span> <span class="p">})</span>
</span><span class="hll">    <span class="p">});</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span><span class="hll">  <span class="nx">async</span> <span class="nx">deleteReview</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="sb">`/reviews/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">    <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Lastly, we’ll update our resolvers once again:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">createReview</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">createReview</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
<span class="hll">    <span class="p">},</span>
</span><span class="hll">    <span class="nx">deleteReview</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">deleteReview</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span>
</span><span class="hll">    <span class="nx">updateReview</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">updateReview</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>Let’s try both new mutations out now. First, we’ll update the review we created in the last section with a new rating and revised text:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">UpdateReview</span><span class="p">(</span><span class="nv">$input</span><span class="p">:</span> <span class="k">UpdateReviewInput</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">updateReview</span><span class="p">(</span>input: <span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">id</span>
    <span class="k">rating</span>
    <span class="k">text</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rating&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;It was pretty good.&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;updateReview&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;rating&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;It was pretty good.&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Now let’s try deleting the same review. Because we are only returning an <code>ID</code> Scalar type from this field, we won’t provide any additional field selections for the response:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">DeleteReview</span><span class="p">(</span><span class="nv">$id</span><span class="p">:</span> <span class="k">ID</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">deleteReview</span><span class="p">(</span>id: <span class="nv">$id</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;deleteReview&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>At this point, the thought may have crossed your mind that we currently have a gaping security hole in our API where users could potentially create, update, or delete reviews the belong to other users. In Chapter 6, we’ll lock this API down and ensure that users are authenticated and authorized to handle only their book reviews before executing these (and several other) mutations.</p>
<h2 id="sign-up-a-new-user">Sign Up a New User</h2>
<p>The final kind of resource to create via the API is a new user. Users must be uniquely identified by their username and email address, so the data source method must enforce this requirement and throw an error if a user tries to select a username that’s already in use or if they try to sign up with an email already assigned to another user. As usual, we’ll start by updating the type definitions:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="hll"><span class="sb">  input SignUpInput {</span>
</span><span class="hll"><span class="sb">    email: String!</span>
</span><span class="hll"><span class="sb">    name: String!</span>
</span><span class="hll"><span class="sb">    username: String!</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll">
</span><span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="sb">    # ...</span>
<span class="hll"><span class="sb">    signUp(input: SignUpInput!): User!</span>
</span><span class="sb">    # ...</span>
<span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<p>To enforce unique usernames and email addresses, we’ll create a utility in the <code>JsonServerApi</code> class that queries the <code>/users</code> endpoint for users with the submitted values. If a user is found matching either value, we’ll throw a <code>UserInputError</code> this time:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="hll"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ForbiddenError</span><span class="p">,</span> <span class="nx">UserInputError</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>
</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">RESTDataSource</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-datasource-rest&quot;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="nx">baseURL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REST_API_BASE_URL</span><span class="p">;</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">checkUniqueUserData</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span><span class="hll">      <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/users?email=</span><span class="si">${</span><span class="nx">email</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span>
</span><span class="hll">      <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/users?username=</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span><span class="hll">    <span class="p">]);</span>
</span><span class="hll">    <span class="kr">const</span> <span class="p">[</span><span class="nx">existingEmail</span><span class="p">,</span> <span class="nx">existingUsername</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="nx">existingEmail</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">throw</span> <span class="k">new</span> <span class="nx">UserInputError</span><span class="p">(</span><span class="s2">&quot;Email is already in use&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">existingUsername</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">throw</span> <span class="k">new</span> <span class="nx">UserInputError</span><span class="p">(</span><span class="s2">&quot;Username already in use&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>While updating <code>JsonServerApi</code>, we’ll also add a new <code>signUp</code> method that calls <code>checkUniqueUserData</code> and creates a new user if no errors are thrown:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">signUp</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">username</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">checkUniqueUserData</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">username</span><span class="p">);</span>
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="p">{</span> 
</span><span class="hll">      <span class="nx">email</span><span class="p">,</span> 
</span><span class="hll">      <span class="nx">name</span><span class="p">,</span> 
</span><span class="hll">      <span class="nx">username</span> 
</span><span class="hll">    <span class="p">});</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Lastly, we can use the new <code>signUp</code> method in the a new <code>signUp</code> mutation resolver:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="hll">    <span class="nx">signUp</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">signUp</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span>
</span>    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>With this code in place, we can try signing up a new user:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">SignUp</span><span class="p">(</span><span class="nv">$input</span><span class="p">:</span> <span class="k">SignUpInput</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">signUp</span><span class="p">(</span>input: <span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">id</span>
    <span class="k">email</span>
    <span class="k">name</span>
    <span class="k">username</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;jo@email.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jo March&quot;</span><span class="p">,</span>
    <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;bookworm68&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;signUp&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;jo@email.com&quot;</span><span class="p">,</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jo March&quot;</span><span class="p">,</span>
      <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;bookworm68&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Before moving on, try signing up a new user with an existing username or email address to confirm that an error is thrown as expected.</p>
<h2 id="update-a-users-library">Update a User’s Library</h2>
<p>The final two mutations that we add in this chapter will allow us to add and remove books to and from a user’s library. If you recall the design of the single book page, there is a button visible to authenticated users that allows them to toggle whether the book is stored in their library. While we could create a single generic mutation to handle either task (and perhaps also update other user fields), we will instead opt for creating purpose-built mutations to support each specific user action in the client application.</p>
<p>To run either mutation, we will need to submit a list of the book IDs that should be added to or removed from a user’s library, as well as the ID of the user in question so that the appropriate <code>userBooks</code> record may be created or deleted. The supporting Input Object type will be identical for both mutations, so we will create a single <code>UpdateLibraryBooksInput</code> type to use for both the <code>addBooksToLibrary</code> and <code>removeBooksFromLibrary</code> mutations:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/typeDefs.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;apollo-server&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="nx">gql</span><span class="sb">`</span>
<span class="sb">  # ...</span>

<span class="hll"><span class="sb">  input UpdateLibraryBooksInput {</span>
</span><span class="hll"><span class="sb">    bookIds: [ID!]!</span>
</span><span class="hll"><span class="sb">    userId: ID!</span>
</span><span class="hll"><span class="sb">  }</span>
</span><span class="hll">
</span><span class="sb">  # ...</span>

<span class="sb">  type Mutation {</span>
<span class="hll"><span class="sb">    addBooksToLibrary(input: UpdateLibraryBooksInput!): User!</span>
</span><span class="sb">    # ...</span>
<span class="hll"><span class="sb">    removeBooksFromLibrary(input: UpdateLibraryBooksInput!): User!</span>
</span><span class="sb">    # ...</span>
<span class="sb">  }</span>
<span class="sb">`</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">typeDefs</span><span class="p">;</span>
</pre></div>

<div class="boxout">
<p>When sharing Input Object types between mutations, it’s important to carefully consider whether the schema may evolve in such a way that would make it awkward for the queries or mutations that rely on it to continue sharing this type. For some cases, it may ultimately make more sense to create separate Input Object types to facilitate schema evolvability.</p>
</div>
<p>Next, we’ll add data source methods for each library-related mutation. It wouldn’t make sense to add the same book to the user’s library twice, so the <code>addBooksToLibrary</code> method will query the <code>/userBooks</code> endpoint of the Bibliotech REST API to see if any records currently exist for each book the user wants to add to their library, filter out any duplicates, and then add records for the new library books:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ..</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">addBooksToLibrary</span><span class="p">({</span> <span class="nx">bookIds</span><span class="p">,</span> <span class="nx">userId</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">      <span class="nx">bookIds</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">bookId</span> <span class="p">=&gt;</span>
</span><span class="hll">        <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/userBooks/?userId=</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">&amp;bookId=</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span><span class="hll">      <span class="p">)</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">existingUserBooks</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">newBookIds</span> <span class="o">=</span> <span class="nx">bookIds</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
</span><span class="hll">      <span class="nx">bookId</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">existingUserBooks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">book</span> <span class="p">=&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">bookId</span><span class="p">))</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">      <span class="nx">bookIds</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">bookId</span> <span class="p">=&gt;</span>
</span><span class="hll">        <span class="k">this</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/userBooks&quot;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="hll">          <span class="nx">bookId</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">bookId</span><span class="p">),</span>
</span><span class="hll">          <span class="nx">createdAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
</span><span class="hll">          <span class="nx">userId</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
</span><span class="hll">        <span class="p">})</span>
</span><span class="hll">      <span class="p">)</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/users/</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>The <code>removeBooksFromLibrary</code> method will also ensure that the books exist in the user’s library before deleting them:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/dataSources/JsonServerApi.js</p>
</div>
<div class="highlight"><pre><span></span><span class="c1">// ..</span>

<span class="kr">class</span> <span class="nx">JsonServerApi</span> <span class="kr">extends</span> <span class="nx">RESTDataSource</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  
<span class="hll">  <span class="nx">async</span> <span class="nx">removeBooksFromLibrary</span><span class="p">({</span> <span class="nx">bookIds</span><span class="p">,</span> <span class="nx">userId</span> <span class="p">})</span> <span class="p">{</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">      <span class="nx">bookIds</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">bookId</span> <span class="p">=&gt;</span>
</span><span class="hll">        <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/userBooks/?userId=</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">&amp;bookId=</span><span class="si">${</span><span class="nx">bookId</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span><span class="hll">      <span class="p">)</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">    <span class="kr">const</span> <span class="nx">existingUserBooks</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">flat</span><span class="p">();</span>
</span><span class="hll">
</span><span class="hll">    <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
</span><span class="hll">      <span class="nx">existingUserBooks</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">id</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="sb">`/userBooks/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span>
</span><span class="hll">    <span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/users/</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="hll">  
</span>  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">JsonServerApi</span><span class="p">;</span>
</pre></div>

<p>Lastly, we’ll create the resolvers for the new mutations:</p>
<p></p>
<div class="code-context">
<p>server/src/graphql/resolvers.js</p>
</div>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">Mutation</span><span class="o">:</span> <span class="p">{</span>
<span class="hll">    <span class="nx">addBooksToLibrary</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">addBooksToLibrary</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span>
</span>    <span class="c1">// ...</span>
<span class="hll">    <span class="nx">removeBooksFromLibrary</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">input</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">dataSources</span> <span class="p">},</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">      <span class="k">return</span> <span class="nx">dataSources</span><span class="p">.</span><span class="nx">jsonServerApi</span><span class="p">.</span><span class="nx">removeBooksFromLibrary</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</span><span class="hll">    <span class="p">},</span>
</span>    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">resolvers</span><span class="p">;</span>
</pre></div>

<p>Now we’re set to add a new book to an existing user’s library:</p>
<p></p>
<div class="code-context">
<p>GraphQL Mutation</p>
</div>
<div class="highlight"><pre><span></span><span class="kt">mutation</span> <span class="k">AddBooksToLibrary</span><span class="p">(</span><span class="nv">$input</span><span class="p">:</span> <span class="k">UpdateLibraryBooksInput</span><span class="p">!)</span> <span class="p">{</span>
  <span class="k">addBooksToLibrary</span><span class="p">(</span>input: <span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">name</span>
    <span class="k">library</span> <span class="p">{</span>
      <span class="k">title</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>Mutation Variables</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;bookIds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="nt">&quot;userId&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p></p>
<div class="code-context">
<p>API Response</p>
</div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;addBooksToLibrary&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice Liddell&quot;</span><span class="p">,</span>
      <span class="nt">&quot;library&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Hitchhiker&#39;s Guide to the Galaxy&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Dispossessed&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Before wrapping up, try running the <code>removeBooksFromLibrary</code> mutation to ensure you can also remove the book that was just added to the same user’s library.</p>
<h2 id="summary">Summary</h2>
<p>At the conclusion of this chapter, our GraphQL API is now capable of both reading and writing data with the addition of several fields on the root <code>Mutation</code> type. Clients can use mutation operations to create authors, books, reviews, and users. They can also update and delete reviews, and they can add and remove books from a user’s library. We used Input Object types to structure complex argument configurations for mutations, and we saw how to throw errors at runtime using the <code>ForbiddenError</code> and <code>UserInputError</code> from Apollo Server.</p>
<p>In the next chapter, we will cover the remaining three named types available in the GraphQL type system, and while doing so, will add pagination to our existing queries and also add search functionality to the Bibliotech API.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://spec.graphql.org/June2018/#sec-Errors">https://spec.graphql.org/June2018/#sec-Errors</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<footer>
<p class="copyright">Copyright © 2021 <a href="https://8bit.press/">8-Bit Press Inc.</a> All rights reserved.</p>
</footer>
</div>
</div>
<script>
(function () {
  "use strict";

  const chapter = document.getElementById("chapter");

  // Set width of fixed-position chapter navigation based on parent
  function setChapterNavWidth() {
    const chapterNav = document.getElementsByClassName("chapter-nav")[0];
    let { width: chapterWidth } = chapter.getBoundingClientRect();
    chapterNav.setAttribute(
      "style",
      `width: ${chapterWidth >= 960 ? chapterWidth * 0.3 + 36 + "px" : "100%"}`
    );
  }

  setChapterNavWidth();
  window.addEventListener("resize", setChapterNavWidth);

  // Open and close the book navigation in the masthead
  const openMastheadButton = document.getElementById("masthead-open");
  const closeMastheadButton = document.getElementById("masthead-close");
  const masthead = document.getElementById("masthead");

  openMastheadButton.addEventListener("click", function (event) {
    event.stopPropagation();
    masthead.style.marginLeft = "0px";
  });

  closeMastheadButton.addEventListener("click", function () {
    masthead.style.marginLeft = "-100%";
  });

  chapter.addEventListener("click", function () {
    if (masthead.style.marginLeft === "0px") {
      masthead.style.marginLeft = "-100%";
    }
  });

  // Add "Copy" button to code snippets
  // Reference: https://tomspencer.dev/blog/2018/09/14/adding-click-to-copy-buttons-to-a-hugo-powered-blog/
  if (!document.queryCommandSupported("copy")) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.textContent = msg;
    setTimeout(function () {
      el.textContent = "Copy";
    }, 1000);
  }

  function selectText(node) {
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    const copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn";
    copyBtn.textContent = "Copy";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener("click", function () {
      try {
        const selection = selectText(codeEl);
        document.execCommand("copy");
        selection.removeAllRanges();

        flashCopyMessage(copyBtn, "Copied!");
      } catch (e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, "Failed :'(");
      }
    });

    containerEl.appendChild(copyBtn);
  }

  // Add copy button to code blocks
  var highlightBlocks = document.getElementsByClassName("highlight");
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>
</body>
</html>